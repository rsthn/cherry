(function(){function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,function(r){var n=e[i][1][r];return o(n||r)},p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}return r})()({1:[function(require,module,exports){const Matrix=module.exports=function(){this.data=[1,0,0,0,1,0,0,0,1]};Matrix.prototype.toString=function(){return`[${this.data[0]}, ${this.data[1]}, ${this.data[2]}]\n[${this.data[3]}, ${this.data[4]}, ${this.data[5]}]\n[${this.data[6]}, ${this.data[7]}, ${this.data[8]}]\n`};Matrix.prototype.zero=function(){for(var i=0;i<9;i++)this.data[i]=0;return this};Matrix.prototype.set=function(value){for(var i=0;i<9;i++)this.data[i]=value;return this};Matrix.prototype.identity=function(){for(var i=0;i<9;i++)this.data[i]=i&3?0:1;return this};Matrix.prototype.scalef=function(f){for(var i=0;i<9;i++)this.data[i]*=f;return this};Matrix.prototype.clone=function(){var matr=new Matrix;for(var i=0;i<9;i++)matr.data[i]=this.data[i];return matr};Matrix.prototype.append=function(matr){var i,j,k,m,temp=[0,0,0,0,0,0,0,0,0];if(matr["data"])matr=matr.data;for(j=0;j<3;j++){for(i=0;i<3;i++){m=0;for(k=0;k<3;k++){m+=this.data[j*3+k]*matr[k*3+i]}temp[j*3+i]=m}}for(i=0;i<9;i++)this.data[i]=temp[i];return this};Matrix.prototype.translate=function(x,y){if(x==0&&y==0)return this;return this.append([1,0,x,0,1,y,0,0,1])};Matrix.prototype.rotate=function(angle){if(angle==0)return this;return this.append([Math.cos(angle),Math.sin(angle),0,-Math.sin(angle),Math.cos(angle),0,0,0,1])};Matrix.prototype.scale=function(sx,sy){if(sx==1&&sy==1)return this;return this.append([sx,0,0,0,sy,0,0,0,1])};Matrix.prototype.applyTo=function(x,y){var nx=this.data[0]*x+this.data[1]*y+this.data[2];var ny=this.data[3]*x+this.data[4]*y+this.data[5];return{x:nx,y:ny}};Matrix.prototype.transpose=function(){var t=new Matrix;for(var j=0;j<3;j++)for(var i=0;i<3;i++)t.data[j*3+i]=this.data[i*3+j];return t};Matrix.prototype.det=function(){return this.data[0]*(this.data[4]*this.data[8]-this.data[5]*this.data[7])-this.data[1]*(this.data[3]*this.data[8]-this.data[5]*this.data[6])+this.data[2]*(this.data[3]*this.data[7]-this.data[4]*this.data[6])};Matrix.prototype.adj=function(){var t=this.transpose();var d=[];d[0]=t.data[4]*t.data[8]-t.data[5]*t.data[7];d[1]=-(t.data[3]*t.data[8]-t.data[5]*t.data[6]);d[2]=t.data[3]*t.data[7]-t.data[4]*t.data[6];d[3]=-(t.data[1]*t.data[8]-t.data[2]*t.data[7]);d[4]=t.data[0]*t.data[8]-t.data[2]*t.data[6];d[5]=-(t.data[0]*t.data[7]-t.data[1]*t.data[6]);d[6]=t.data[1]*t.data[5]-t.data[2]*t.data[4];d[7]=-(t.data[0]*t.data[5]-t.data[2]*t.data[3]);d[8]=t.data[0]*t.data[4]-t.data[1]*t.data[3];t.data=d;return t};Matrix.prototype.inverse=function(){var det=this.det();if(!det)return null;return this.adj().scalef(1/det)}},{}],2:[function(require,module,exports){const Rin=require("@rsthn/rin/alpha");const Class=require("@rsthn/rin/class");const Anim=module.exports=Class.extend({list:null,initialData:null,data:null,stack:null,block:null,time:0,blockTime:0,index:0,paused:false,finished:false,onFinishedCallback:null,__ctor:function(){this.list=[];this.initialData={};this.data={};this.stack=[];this.block=this.list;this.reset()},__dtor:function(){},clone:function(){var a=new Anim;a.list=this.list;a.initialData=this.initialData;return a.reset()},onFinished:function(callback){this.onFinishedCallback=callback;return this},reset:function(){this.stack.length=0;this.blockTime=0;this.time=0;this.index=0;this.block=this.list;this.paused=false;this.finished=false;for(var i in this.initialData)this.data[i]=this.initialData[i];return this},initial:function(data){this.initialData=data;return this.reset()},setOutput:function(data){this.data=data;return this},pause:function(){this.paused=true},resume:function(){this.paused=false},update:function(dt){if(this.paused)return false;if(this.index>=this.block.length)return true;var i=0;this.time+=dt;while(this.index<this.block.length){var cmd=this.block[this.index];var duration;switch(cmd.op){case"parallel":if(cmd.started==false){cmd.blocks.length=0;cmd.started=true;for(i=0;i<cmd.block.length;i++){cmd.blocks.push([cmd.block[i]]);cmd.indices[i]=0;cmd.blockTimes[i]=this.blockTime}}var _block=this.block;var _index=this.index;var _blockTime=this.blockTime;var n=0;var blockTime=_blockTime;for(i=0;i<cmd.blocks.length;i++){this.block=cmd.blocks[i];this.index=cmd.indices[i];this.blockTime=cmd.blockTimes[i];if(this.update(0)===true)n++;if(this.blockTime>blockTime)blockTime=this.blockTime;cmd.blockTimes[i]=this.blockTime;cmd.blocks[i]=this.block;cmd.indices[i]=this.index}this.block=_block;this.index=_index;this.blockTime=_blockTime;if(cmd.fn)cmd.fn.call(this);if(n!=cmd.blocks.length)return false;cmd.started=false;this.blockTime=blockTime;this.index++;break;case"serial":if(cmd.started==false){cmd._block=cmd.block;cmd._index=0;cmd._blockTime=this.blockTime;cmd.started=true}var _block=this.block;var _index=this.index;var _blockTime=this.blockTime;this.block=cmd._block;this.index=cmd._index;this.blockTime=cmd._blockTime;i=this.update(0);cmd._block=this.block;cmd._index=this.index;cmd._blockTime=this.blockTime;this.block=_block;this.index=_index;this.blockTime=_blockTime;if(cmd.fn)cmd.fn.call(this);if(i!==true)return false;cmd.started=false;this.blockTime=cmd._blockTime;this.index++;break;case"repeat":if(cmd.started==false){cmd._block=cmd.block;cmd._index=0;cmd._blockTime=this.blockTime;cmd._count=cmd.count;cmd.started=true}var _block=this.block;var _index=this.index;var _blockTime=this.blockTime;this.block=cmd._block;this.index=cmd._index;this.blockTime=cmd._blockTime;i=this.update(0);cmd._block=this.block;cmd._index=this.index;cmd._blockTime=this.blockTime;this.block=_block;this.index=_index;this.blockTime=_blockTime;if(cmd.fn)cmd.fn.call(this);if(i!==true)return false;if(cmd._count<=1){cmd.started=false;this.blockTime=cmd._blockTime;this.index++;return false}else{cmd._index=0;cmd._count--;return false}break;case"set":this.data[cmd.field]=cmd.value;this.index++;break;case"restart":this.index=0;break;case"wait":duration=Rin.typeOf(cmd.duration)=="string"?this.data[cmd.duration]:cmd.duration;if(this.time<this.blockTime+duration)return false;this.blockTime+=duration;this.index++;break;case"range":if(cmd.started==false){if(cmd.startValue===null)cmd._startValue=this.data[cmd.field];else cmd._startValue=cmd.startValue;cmd._endValue=cmd.endValue;cmd.started=true}duration=Rin.typeOf(cmd.duration)=="string"?this.data[cmd.duration]:cmd.duration;if(this.time<this.blockTime+duration)dt=(this.time-this.blockTime)/duration;else dt=1;if(cmd.easing&&dt!=1)this.data[cmd.field]=cmd.easing(dt)*(cmd._endValue-cmd._startValue)+cmd._startValue;else this.data[cmd.field]=dt*(cmd._endValue-cmd._startValue)+cmd._startValue;if(dt!=1)return false;cmd.started=false;this.blockTime+=duration;this.index++;break;case"rand":if(cmd.started==false){cmd.started=true;cmd.last=null}duration=Rin.typeOf(cmd.duration)=="string"?this.data[cmd.duration]:cmd.duration;if(this.time<this.blockTime+duration)dt=(this.time-this.blockTime)/duration;else dt=1;if(cmd.easing&&dt!=1)cmd.cur=~~(cmd.easing(dt)*cmd.count);else cmd.cur=~~(dt*cmd.count);if(cmd.cur!=cmd.last){while(true){i=~~(Math.random()*(cmd.endValue-cmd.startValue+1))+cmd.startValue;if(i!=this.data[cmd.field])break}this.data[cmd.field]=i;cmd.last=cmd.cur}if(dt!=1)return false;cmd.started=false;this.blockTime+=duration;this.index++;break;case"randt":duration=Rin.typeOf(cmd.duration)=="string"?this.data[cmd.duration]:cmd.duration;if(this.time<this.blockTime+duration)dt=(this.time-this.blockTime)/duration;else dt=1;if(cmd.easing&&dt!=1)i=cmd.easing(dt)*(cmd.count-1);else i=dt*(cmd.count-1);this.data[cmd.field]=cmd.table[~~((i+cmd.count)%cmd.count)];if(dt!=1)return false;this.blockTime+=duration;this.index++;break;case"play":cmd.snd.play();this.index++;break;case"exec":cmd.fn.call(this);this.index++;break}}if(this.block==this.list){if(!this.finished&&this.onFinishedCallback!=null)this.onFinishedCallback();this.finished=true}return true},parallel:function(){var block=[];this.block.push({op:"parallel",started:false,block:block,blocks:[],indices:[],blockTimes:[]});this.stack.push(this.block);this.block=block;return this},serial:function(){var block=[];this.block.push({op:"serial",started:false,block:block});this.stack.push(this.block);this.block=block;return this},repeat:function(count){var block=[];this.block.push({op:"repeat",started:false,block:block,count:count});this.stack.push(this.block);this.block=block;return this},callback:function(fn){var block=this.stack[this.stack.length-1];block[block.length-1].fn=fn;return this},end:function(){this.block=this.stack.pop();return this},set:function(field,value){this.block.push({op:"set",field:field,value:value});return this},restart:function(duration){this.block.push({op:"restart"});return this},wait:function(duration){this.block.push({op:"wait",duration:duration});return this},range:function(field,duration,startValue,endValue,easing){this.block.push({op:"range",started:false,field:field,duration:duration,startValue:startValue,endValue:endValue,easing:easing?easing:null});return this},rand:function(field,duration,count,startValue,endValue,easing){this.block.push({op:"rand",started:false,field:field,duration:duration,count:count,startValue:startValue,endValue:endValue,easing:easing?easing:null});return this},randt:function(field,duration,count,startValue,endValue,easing){var table=[];for(var i=0;i<count;i++)table.push(i%(endValue-startValue+1)+startValue);for(var i=count>>2;i>0;i--){var a=~~(Math.random()*count);var b=~~(Math.random()*count);var c=table[b];table[b]=table[a];table[a]=c}this.block.push({op:"randt",field:field,duration:duration,count:count,startValue:startValue,endValue:endValue,table:table,easing:easing?easing:null});return this},play:function(snd){this.block.push({op:"play",snd:snd});return this},exec:function(fn){this.block.push({op:"exec",fn:fn});return this}})},{"@rsthn/rin/alpha":34,"@rsthn/rin/class":35}],3:[function(require,module,exports){(function(global){const Rin=require("@rsthn/rin/alpha");const Matrix=require("./Matrix");const Canvas=module.exports=function(elem,opts){if(elem==null){this.elem=global.document?global.document.createElement("canvas"):Rin.clone(Canvas.passThruCanvas);if(global.document&&opts&&opts.hidden!=true)global.document.body.appendChild(this.elem)}else{this.elem=elem}if(!this.elem.getContext)return;this.context=this.elem.getContext("2d");this.antialias=opts&&opts.antialias===false?false:true;this.setBackground(opts&&opts.background!=null?opts.background:"#000");this.matrixStack=[];this.alphaStack=[];this.matr=new Matrix;this._alpha=1;this._globalScale=1;this.matr.identity();this.transform();this.strokeStyle("#fff");this.fillStyle("#fff");this.resize()};Canvas.passThruCanvas={parentNode:null,imageSmoothingEnabled:true,style:{},width:950,height:540,getContext:function(renderingContext){return this},save:function(){},restore:function(){},scale:function(sx,sy){},rotate:function(angle){},translate:function(x,y){},setTransform:function(a,b,c,d,e,f){},transform:function(a,b,c,d,e,f){},toDataURL:function(mime,params){return""},beginPath:function(){},moveTo:function(x,y){},closePath:function(){},lineTo:function(){},rect:function(x,y,w,h){},fill:function(){},stroke:function(){},fillRect:function(x,y,w,h){},strokeRect:function(x,y,w,h){},clip:function(){},quadraticCurveTo:function(cpx,cpy,x,y){},bezierCurveTo:function(cx1,cy1,cx2,cy2,x,y){},arc:function(x,y,r,sA,eA,cw){},arcTo:function(x1,y1,x2,y2,r){},fillText:function(text,x,y,maxWidth){},strokeText:function(text,x,y,maxWidth){},measureText:function(text){return{width:0}},createImageData:function(w,h){return{width:w,height:h}},getImageData:function(x,y,w,h){return{width:w,height:h,data:[]}},putImageData:function(data,x,y){},drawImage:function(...args){},getBoundingClientRect:function(){return{left:0,top:0}}};Canvas.prototype.applyConfig=function(){if(this.antialias==false){this.context.imageSmoothingEnabled=false;this.elem.style.imageRendering="crisp-edges"}else{this.context.imageSmoothingEnabled=true;this.elem.style.imageRendering="auto"}};Canvas.prototype.dispose=function(){if(this.elem.parentNode)this.elem.parentNode.removeChild(this.elem);this.matrixStack=null;this.alphaStack=null;this.matr=null;this.context=null;this.elem=null};Canvas.prototype.setBackground=function(color,canvasColor){this.elem.style.background=color;this.backgroundColor=canvasColor?canvasColor:color};Canvas.prototype.resize=function(width,height){let rect=this.elem.getBoundingClientRect();if(!width)width=rect.width;if(!height)height=rect.height;this.elem.width=width;this.elem.height=height;this.width=this.elem.width;this.height=this.elem.height;this._width=~~(this.width/this._globalScale);this._height=~~(this.height/this._globalScale);this.applyConfig();return this};Canvas.prototype.globalScale=function(value){this._globalScale=value;this._width=~~(this.width/this._globalScale);this._height=~~(this.height/this._globalScale);this.loadIdentity();this.scale(value,value);return this};Canvas.prototype.flipped=function(value){if(value){this._width=~~(this.height/this._globalScale);this._height=~~(this.width/this._globalScale)}else{this._width=~~(this.width/this._globalScale);this._height=~~(this.height/this._globalScale)}return this};Canvas.prototype.save=function(){this.context.save();return this};Canvas.prototype.restore=function(){this.context.restore();return this};Canvas.prototype.toDataUrl=function(mime,params){return this.elem.toDataURL(mime,params)};Canvas.prototype.toPng64=function(){return this.elem.toDataURL("image/png").substr(22)};Canvas.prototype._contextAttribute=function(name,value){if(value!==undefined){this.context[name]=value;return this}return this.context[name]};Canvas.prototype.fillStyle=function(value){return this._contextAttribute("fillStyle",value)};Canvas.prototype.strokeStyle=function(value){return this._contextAttribute("strokeStyle",value)};Canvas.prototype.lineCap=function(value){return this._contextAttribute("lineCap",value)};Canvas.prototype.lineJoin=function(value){return this._contextAttribute("lineJoin",value)};Canvas.prototype.lineWidth=function(value){return this._contextAttribute("lineWidth",value)};Canvas.prototype.miterLimit=function(value){return this._contextAttribute("miterLimit",value)};Canvas.prototype.shadowColor=function(value){return this._contextAttribute("shadowColor",value)};Canvas.prototype.shadowOffsetX=function(value){return this._contextAttribute("shadowOffsetX",value)};Canvas.prototype.shadowOffsetY=function(value){return this._contextAttribute("shadowOffsetY",value)};Canvas.prototype.shadowBlur=function(value){return this._contextAttribute("shadowBlur",value)};Canvas.prototype.font=function(value){return this._contextAttribute("font",value)};Canvas.prototype.textAlign=function(value){return this._contextAttribute("textAlign",value)};Canvas.prototype.textBaseline=function(value){return this._contextAttribute("textBaseline",value)};Canvas.prototype.globalAlpha=function(value){if(value!==undefined)this._alpha=value;else return this._alpha;return this.alpha(1)};Canvas.prototype.alpha=function(value){this._alpha*=value;this.context.globalAlpha=this._alpha;return this};Canvas.prototype.globalCompositeOperation=function(value){return this._contextAttribute("globalCompositeOperation",value)};Canvas.prototype.transform=function(a,b,c,d,e,f){if(!arguments.length){this.context.setTransform(this.matr.data[0],this.matr.data[3],this.matr.data[1],this.matr.data[4],this.matr.data[2],this.matr.data[5]);return this}this.context.transform(a,b,c,d,e,f);return this};Canvas.prototype.setTransform=function(a,b,c,d,e,f){this.context.setTransform(a,b,c,d,e,f);return this};Canvas.prototype.fillRect=function(x,y,w,h){this.context.fillRect(x,y,w,h);return this};Canvas.prototype.strokeRect=function(x,y,w,h){this.context.strokeRect(x,y,w,h);return this};Canvas.prototype.clearRect=function(x,y,w,h){this.context.clearRect(x,y,w,h);return this};Canvas.prototype.beginPath=function(){this.context.beginPath();return this};Canvas.prototype.moveTo=function(x,y){this.context.moveTo(x,y);return this};Canvas.prototype.closePath=function(){this.context.closePath();return this};Canvas.prototype.lineTo=function(x,y){this.context.lineTo(x,y);return this};Canvas.prototype.rect=function(x,y,w,h){this.context.rect(x,y,w,h);return this};Canvas.prototype.fill=function(value){if(value)this.fillStyle(value);this.context.fill();return this};Canvas.prototype.stroke=function(value){if(value)this.strokeStyle(value);this.context.stroke();return this};Canvas.prototype.clip=function(){this.context.clip();return this};Canvas.prototype.quadraticCurveTo=function(cpx,cpy,x,y){this.context.quadraticCurveTo(cpx,cpy,x,y);return this};Canvas.prototype.bezierCurveTo=function(cx1,cy1,cx2,cy2,x,y){this.context.bezierCurveTo(cx1,cy1,cx2,cy2,x,y);return this};Canvas.prototype.arc=function(x,y,r,sA,eA,cw){this.context.arc(x,y,r,sA,eA,cw);return this};Canvas.prototype.arcTo=function(x1,y1,x2,y2,r){this.context.arcTo(x1,y1,x2,y2,r);return this};Canvas.prototype.fillText=function(text,x,y,maxWidth){this.context.fillText(text,x,y,maxWidth?maxWidth:1e3);return this};Canvas.prototype.strokeText=function(text,x,y,maxWidth){this.context.strokeText(text,x,y,maxWidth?maxWidth:1e3);return this};Canvas.prototype.measureText=function(text){return this.context.measureText(text).width};Canvas.prototype.createImageData=function(w,h){return this.context.createImageData(w,h)};Canvas.prototype.getImageData=function(x,y,w,h){return this.context.getImageData(x,y,w,h)};Canvas.prototype.putImageData=function(data,x,y){this.context.putImageData(data,x,y);return this};Canvas.prototype.drawImage=function(...args){if(args.length==3){this.context.drawImage(args[0],~~args[1],~~args[2])}else if(args.length==5){this.context.drawImage(args[0],~~args[1],~~args[2],~~args[3],~~args[4])}else if(args.length==9){var a3=~~args[3];var a4=~~args[4];if(!a3||!a4)return this;var a7=~~args[7];var a8=~~args[8];if(!a7||!a8)return this;this.context.drawImage(args[0],~~args[1],~~args[2],a3,a4,~~args[5],~~args[6],a7,a8)}return this};Canvas.prototype.clear=function(backgroundColor){if(backgroundColor){this.globalCompositeOperation("source-over").globalAlpha(1).fillStyle(backgroundColor!==true?backgroundColor:this.backgroundColor).fillRect(0,0,this._width,this._height)}else{this.elem.width=this.width;this.applyConfig()}this.transform();return this};Canvas.prototype.reset=function(clearPath){this.fillStyle("#000000").strokeStyle("#000000").lineCap("butt").lineJoin("miter").lineWidth("1").miterLimit("10").shadowColor("#000000").shadowOffsetX("0").shadowOffsetY("0").shadowBlur("0").globalAlpha("1.0").globalCompositeOperation("source-over");if(clearPath)this.beginPath().closePath();return this};Canvas.prototype.pushMatrix=function(){this.matrixStack.push(this.matr);this.matr=this.matr.clone();return this};Canvas.prototype.popMatrix=function(){this.matr=this.matrixStack.pop();return this.transform()};Canvas.prototype.pushAlpha=function(){this.alphaStack.push(this.globalAlpha());return this};Canvas.prototype.popAlpha=function(){this.globalAlpha(this.alphaStack.pop());return this};Canvas.prototype.loadIdentity=function(){this.matr.identity();return this.transform()};Canvas.prototype.loadMatrix=function(matr){this.matr.identity().append(matr);return this.transform()};Canvas.prototype.getMatrix=function(){return this.matr.clone()};Canvas.prototype.appendMatrix=function(matr){this.matr.append(matr);return this.transform()};Canvas.prototype.scale=function(sx,sy,useNative){if(useNative){this.context.scale(sx,sy);return this}this.matr.scale(sx,sy);return this.transform()};Canvas.prototype.rotate=function(angle,useNative){if(useNative){this.context.rotate(angle);return this}this.matr.rotate(angle);return this.transform()};Canvas.prototype.translate=function(x,y,useNative){if(useNative){this.context.translate(x,y);return this}this.matr.translate(x,y);return this.transform()};Canvas.prototype.ellipse=function(x,y,w,h){var ox=w/2*.5522848,oy=h/2*.5522848;var xe=x+w-1,ye=y+h-1,xm=x+w/2,ym=y+h/2;this.beginPath().moveTo(x,ym);this.bezierCurveTo(x,ym-oy,xm-ox,y,xm,y);this.bezierCurveTo(xm+ox,y,xe,ym-oy,xe,ym);this.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);this.bezierCurveTo(xm-ox,ye,x,ym+oy,x,ym);this.closePath();return this};Canvas.prototype.circle=function(x,y,r,stroke){this.beginPath();this.arc(x,y,r,0,2*Math.PI);this.closePath();if(stroke)this.stroke(stroke);return this};Canvas.prototype.line=function(x1,y1,x2,y2,stroke){this.beginPath();this.moveTo(x1,y1);this.lineTo(x2,y2);this.closePath();if(stroke)this.stroke(stroke);return this};Canvas.prototype.enablePointerEvents=function(){if(this.pointerHandler)return this;this.pointerScale={sx:1,sy:1};this.pointerOffset={x:0,y:0};var _=this;var _evt={action:"",buttons:0,lbuttons:0,x:0,y:0,containedBy:function(x,y,w,h){return this.x>=x&&this.x<=x+w-1&&this.y>=y&&this.y<=y+h-1}};this.pointerHandlers=[];this.pointerHandler=function(code,evt){var rect=this.elem.getBoundingClientRect();_evt.action=code;_evt.buttons=evt.buttons;_evt.x=_evt.rx=~~(evt.clientX-rect.left);_evt.y=_evt.ry=~~(evt.clientY-rect.top);_evt.x=(_evt.x-_.pointerOffset.x-0*_.pointerScale.sx)/_.pointerScale.sx;_evt.y=(_evt.y-_.pointerOffset.y-0*_.pointerScale.sy)/_.pointerScale.sy;_evt.dragging=false;if(_evt.buttons&&!_evt.lbuttons){_evt.sx=_evt.x;_evt.sy=_evt.y;_evt.ldx=_evt.ldy=0}if(_evt.buttons&&_evt.lbuttons){_evt.dragging=true;_evt.dx=_evt.x-_evt.sx;_evt.dy=_evt.y-_evt.sy;_evt.ddx=_evt.dx-_evt.ldx;_evt.ddy=_evt.dy-_evt.ldy;_evt.ldx=_evt.dx;_evt.ldy=_evt.dy}_evt.lbuttons=_evt.buttons;for(var i=0;i<this.pointerHandlers.length;i++){if(this.pointerHandlers[i][1].call(this.pointerHandlers[i][2],_evt)===false)break}};this.elem.onmousedown=function(evt){_.pointerHandler("DOWN",evt)};this.elem.onmouseup=function(evt){_.pointerHandler("UP",evt)};this.elem.onmousemove=function(evt){_.pointerHandler("MOVE",evt)};return this};Canvas.prototype.setPointerScale=function(sx,sy){this.pointerScale={sx:sx,sy:sy};return this};Canvas.prototype.setPointerOffset=function(x,y){this.pointerOffset={x:x,y:y};return this};Canvas.prototype.addPointerHandler=function(callback,context){this.enablePointerEvents();this.pointerHandlers.push([this.pointerHandlers.length+"_"+~~(Math.random()*1e6),callback,context]);return this.pointerHandlers[this.pointerHandlers.length-1][0]};Canvas.prototype.removePointerHandler=function(id){if(!this.pointerHandlers)return;for(var i=0;i<this.pointerHandlers.length;i++){if(this.pointerHandlers[i][0]==id){this.pointerHandlers.splice(i,1);break}}};Canvas.prototype.drawImageResource=function(image,x,y,width,height){if(width==null)return this.drawImage(image.data,0,0,image.data.width,image.data.height,x,y,image.width,image.height);return this.drawImage(image.data,0,0,image.data.width,image.data.height,x,y,width,height)}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./Matrix":1,"@rsthn/rin/alpha":34}],4:[function(require,module,exports){module.exports={FPS:60,ANTIALIAS:false,BACKGROUND:"#000",ORIENTATION:0,WIDTH:360,HEIGHT:640,ORIGINAL_TILE_SIZE:32,TILE_SIZE:64,BOARD_WIDTH:10,BOARD_HEIGHT:5,SCALE:1,init:function(){this.SCALE=this.TILE_SIZE/this.ORIGINAL_TILE_SIZE}}},{}],5:[function(require,module,exports){const System=require("./system");module.exports={LEFT:0,RIGHT:1,TOP:0,BOTTOM:1,CENTER:2,getXByRef:function(refX){return refX==this.CENTER?System.screenWidth*.5:refX==this.LEFT?0:System.screenWidth-1},getYByRef:function(refY){return refY==this.CENTER?System.screenHeight*.5:refY==this.TOP?0:System.screenHeight-1},getFByRef:function(ref){return ref==this.CENTER?-.5:ref&1?-1:0}};module.exports.Button=require("./controls/button");module.exports.Stick=require("./controls/stick")},{"./controls/button":6,"./controls/stick":7,"./system":44}],6:[function(require,module,exports){const Class=require("@rsthn/rin/class");const Controls=require("../controls");const Rect=require("../rect");module.exports=Class.extend({bounds:null,hbounds:null,focusLock:false,visible:true,refX:0,refY:0,offsX:0,offsY:0,status:0,pstatus:0,unpressedImg:null,pressedImg:null,__ctor:function(refX,refY,offsX,offsY,unpressedImg,pressedImg){this.unpressedImg=unpressedImg;this.pressedImg=pressedImg;var x=Controls.getXByRef(this.refX=refX);var y=Controls.getYByRef(this.refY=refY);offsX=(refX&1?-1:1)*(this.offsX=offsX);offsY=(refY&1?-1:1)*(this.offsY=offsY);x+=Controls.getFByRef(this.refX)*unpressedImg.width+offsX;y+=Controls.getFByRef(this.refY)*unpressedImg.height+offsY;this.bounds=Rect.alloc(this.unpressedImg.width,this.unpressedImg.height);this.bounds.translate(x-this.bounds.x1,y-this.bounds.y1);this.hbounds=Rect.alloc();this.hbounds.set(this.bounds)},containsPoint:function(x,y){return this.visible==true?this.hbounds.containsPoint(x,y):false},draw:function(g){if(!this.visible)return;this.preDraw(g);if(this.status){if(!this.pressedImg){g.pushMatrix();g.translate(this.bounds.cx,this.bounds.cy);g.scale(.8,.8);this.unpressedImg.draw(g,-this.unpressedImg.width*.5,-this.unpressedImg.height*.5);g.popMatrix()}else this.pressedImg.draw(g,this.bounds.x1,this.bounds.y1)}else this.unpressedImg.draw(g,this.bounds.x1,this.bounds.y1);this.postDraw(g)},preDraw:function(g){},postDraw:function(g){},activate:function(pointer){pointer._ref=this;this.pstatus=this.status;this.status=1;this.onChange(this.status,this.pstatus)},deactivate:function(pointer){pointer._ref=null;this.pstatus=this.status;this.status=0;this.onChange(this.status,this.pstatus)},update:function(pointerX,pointerY){},reset:function(){this.status=this.pstatus=0;this.onChange(this.status,this.pstatus)},onChange:function(status,pstatus){if(status==0&&pstatus==1)this.onTap()},onTap:function(){}})},{"../controls":5,"../rect":41,"@rsthn/rin/class":35}],7:[function(require,module,exports){const Class=require("@rsthn/rin/class");const Controls=require("../controls");const Rect=require("../rect");module.exports=Class.extend({bounds:null,focusLock:true,visible:true,refX:0,refY:0,offsX:0,offsY:0,dispX:0,dispY:0,angle:0,radius:0,angleSteps:0,radiusSteps:0,rdirX:0,rdirY:0,dirX:0,dirY:0,magnitude:0,outerImg:null,innerImg:null,maxRadius:0,__ctor:function(refX,refY,offsX,offsY,outerImg,innerImg,maxRadiusRatio){this.maxRadius=maxRadiusRatio*outerImg.width*.5;this.outerImg=outerImg;this.innerImg=innerImg;var x=Controls.getXByRef(this.refX=refX);var y=Controls.getYByRef(this.refY=refY);offsX=(refX&1?-1:1)*(this.offsX=offsX);offsY=(refY&1?-1:1)*(this.offsY=offsY);x+=Controls.getFByRef(this.refX)*outerImg.width+offsX;y+=Controls.getFByRef(this.refY)*outerImg.height+offsY;this.bounds=Rect.alloc(this.outerImg.width,this.outerImg.height);this.bounds.translate(x-this.bounds.x1,y-this.bounds.y1)},containsPoint:function(x,y){return this.visible==true?this.bounds.containsPoint(x,y):false},draw:function(g){if(!this.visible)return;var x=this.bounds.x1;var y=this.bounds.y1;this.outerImg.draw(g,x,y);this.innerImg.draw(g,this.bounds.cx-this.innerImg.width*.5+this.dispX,this.bounds.cy-this.innerImg.height*.5+this.dispY)},activate:function(pointer){pointer._ref=this},deactivate:function(pointer){pointer._ref=null;this.reset()},update:function(pointerX,pointerY){var dx=pointerX-this.bounds.cx;var dy=pointerY-this.bounds.cy;this.angle=Math.atan2(-dy,dx);this.radius=Math.sqrt(dx*dx+dy*dy);if(this.radius>this.maxRadius)this.radius=this.maxRadius;if(this.angleSteps){var fs=2*Math.PI/this.angleSteps;this.angle=int((this.angle+Math.PI+fs/2)/fs)*fs-Math.PI}if(this.radiusSteps){var fs=this.maxRadius/this.radiusSteps;this.radius=int((this.radius+fs/2)/fs)*fs}this.rdirX=Math.min(1,Math.max(dx/this.maxRadius,-1));this.rdirY=Math.min(1,Math.max(dy/this.maxRadius,-1));this.dispX=this.radius*Math.cos(this.angle);this.dispY=this.radius*-Math.sin(this.angle);if(this.radius>0){this.dirX=this.dispX/this.radius;this.dirY=this.dispY/this.radius;this.magnitude=this.radius/this.maxRadius}else{this.dirX=0;this.dirY=0;this.magnitude=0}this.onChange(this.dirX,this.dirY,this.magnitude,this.angle)},reset:function(){this.dispX=0;this.dispY=0;this.rdirX=0;this.rdirY=0;this.dirX=0;this.dirY=0;this.magnitude=0;this.onChange(this.dirX,this.dirY,this.magnitude,this.angle)},onChange:function(dirX,dirY,magnitude,angle){}})},{"../controls":5,"../rect":41,"@rsthn/rin/class":35}],8:[function(require,module,exports){const QuadTreeItem=require("./quadtree-item");const Fragment=require("./fragment");const List=require("./list");const DisplayElement=module.exports=QuadTreeItem.extend({className:"DisplayElement",layer:null,fragments:null,x:0,y:0,scrX:0,scrY:0,__ctor:function(width,height){this._super.QuadTreeItem.__ctor();this.layer=null;this.setPosition(0,0);this.bounds.resize(width,height);this.lbounds.resize(width,height)},__reinit:function(width,height){this._super.QuadTreeItem.__reinit();this.layer=null;this.setPosition(0,0);this.bounds.resize(width,height);this.lbounds.resize(width,height)},__dtor:function(){if(this.fragments!=null&&this.layer!=null){for(let i=this.fragments.top;i;i=i.next)this.layer.removeItem(i.value)}if(this.fragments!=null)dispose(this.fragments);if(this.layer!=null)this.layer.removeItem(this);this._super.QuadTreeItem.__dtor()},setLayer:function(layer){if(!layer)return this;if(this.layer!=null){this.layer.removeItem(this);if(this.fragments!=null){for(let i=this.fragments.top;i;i=i.next)this.layer.removeItem(i.value)}}if(this.fragments!=null){for(let i=this.fragments.top;i;i=i.next)this.layer.addItem(i.value)}return(this.layer=layer).addItem(this)},setVisible:function(value){this._super.QuadTreeItem.setVisible(value);if(this.fragments!=null){for(let i=this.fragments.top;i;i=i.next)i.value.setVisible(value)}return this},addFragment:function(dx,dy,w,h){if(this.fragments==null)this.fragments=new List;let fragment=new Fragment(this,dx,dy,w,h);this.fragments.push(fragment);if(this.layer!=null)this.layer.addItem(fragment);return fragment},getNumFragments:function(){return this.fragments!=null?this.fragments.count:0},getFragments:function(){return this.fragments},onPositionChanged:function(x,y,zi){var dx=x-this.bounds.cx;var dy=y-this.bounds.cy;var dzi=zi-this.zindex;this.x+=dx;this.y+=dy;this.zindex+=dzi;this.scrX=this.x;this.scrY=this.y;this.bounds.translate(dx,dy);this.lbounds.translate(dx,dy);if(this.layer!=null)this.layer.updateItem(this);if(this.fragments!=null&&this.layer!=null){for(let i=this.fragments.top;i;i=i.next){i.value.translate(dx,dy);this.layer.updateItem(i.value)}}},setPosition:function(x,y,dontUseCenter){if(dontUseCenter===true){x+=this.bounds.cx-this.bounds.x1;y+=this.bounds.cy-this.bounds.y1}this.onPositionChanged(x,y,this.zindex);return this},getScrX:function(){return this.scrX},getScrY:function(){return this.scrY},setX:function(x){this.onPositionChanged(x,this.bounds.cy,this.zindex);return this},setY:function(y){this.onPositionChanged(this.bounds.cx,y,this.zindex);return this},getX:function(){return this.x},getY:function(){return this.y},translate:function(dx,dy,dzi=0){this.onPositionChanged(this.bounds.cx+dx,this.bounds.cy+dy,this.zindex+dzi);return this},update:function(dt){},draw:function(g){}});DisplayElement.FLAG_FRAGMENT=1*QuadTreeItem.FLAG_USERDEF;DisplayElement.FLAG_HOLLOW=2*QuadTreeItem.FLAG_USERDEF;Object.assign(exports,module.exports)},{"./fragment":10,"./list":30,"./quadtree-item":38}],9:[function(require,module,exports){const Easing=module.exports={Linear:{IN:function(t){return t},OUT:function(t){return t},IN_OUT:function(t){return t}},Back:{k:1.70158,IN:function(t,k){if(k===undefined)k=Easing.Back.k;return t*t*((k+1)*t-k)},OUT:function(t,k){return 1-Easing.Back.IN(1-t,k)},IN_OUT:function(t,k){if(t<.5)return Easing.Back.IN(t*2,k)/2;else return Easing.Back.OUT((t-.5)*2,k)/2+.5}},Bounce:{getConst:function(t){if(t<1/2.75)return 7.5625*t*t;else if(t<2/2.75)return 7.5625*(t-=1.5/2.75)*t+.75;else if(t<2.5/2.75)return 7.5625*(t-=2.25/2.75)*t+.9375;return 7.5625*(t-=2.625/2.75)*t+.984375},IN:function(t){return 1-Easing.Bounce.getConst(1-t)},OUT:function(t){return Easing.Bounce.getConst(t)},IN_OUT:function(t){if(t<.5)return(1-Easing.Bounce.getConst(1-2*t))/2;else return Easing.Bounce.getConst((t-.5)*2)/2+.5}},Circ:{IN:function(t){return 1-Math.sqrt(1-t*t)},OUT:function(t){return 1-Easing.Circ.IN(1-t)},IN_OUT:function(t){if(t<.5)return Easing.Circ.IN(t*2)/2;else return Easing.Circ.OUT((t-.5)*2)/2+.5}},Cubic:{IN:function(t){return t*t*t},OUT:function(t){return 1-Easing.Cubic.IN(1-t)},IN_OUT:function(t){if(t<.5)return Easing.Cubic.IN(t*2)/2;else return Easing.Cubic.OUT((t-.5)*2)/2+.5}},Expo:{IN:function(t){return Math.pow(2,12*(t-1))},OUT:function(t){return-Math.pow(2,-12*t)+1},IN_OUT:function(t){if((t*=2)<1)return Math.pow(2,12*(t-1))/2;else return(-Math.pow(2,-12*(t-1))+2)/2}},Power:{p:12,IN:function(t){return Math.pow(t,Easing.Power.p)},OUT:function(t){return 1-Easing.Power.IN(1-t)},IN_OUT:function(t){if(t<.5)return Easing.Power.IN(t*2)/2;else return Easing.Power.OUT((t-.5)*2)/2+.5}},Quad:{IN:function(t){return t*t},OUT:function(t){return 1-Easing.Quad.IN(1-t)},IN_OUT:function(t){if(t<.5)return Easing.Quad.IN(t*2)/2;else return Easing.Quad.OUT((t-.5)*2)/2+.5}},Quartic:{IN:function(t){return t*t*t*t},OUT:function(t){return 1-Easing.Quartic.IN(1-t)},IN_OUT:function(t){if(t<.5)return Easing.Quartic.IN(t*2)/2;else return Easing.Quartic.OUT((t-.5)*2)/2+.5}},Quintic:{IN:function(t){return t*t*t*t*t},OUT:function(t){return 1-Easing.Quintic.IN(1-t)},IN_OUT:function(t){if(t<.5)return Easing.Quintic.IN(t*2)/2;else return Easing.Quintic.OUT((t-.5)*2)/2+.5}},Sine:{IN:function(t){return 1-Math.sin(1.5708*(1-t))},OUT:function(t){return Math.sin(1.5708*t)},IN_OUT:function(t){return(Math.cos(3.1416*t)-1)/-2}},Step:{IN:function(t){return t!=1?0:1},OUT:function(t){return t!=1?0:1},IN_OUT:function(t){return t!=1?0:1}}}},{}],10:[function(require,module,exports){const QuadTreeItem=require("./quadtree-item");const DisplayElement=require("./display-element");const Fragment=module.exports=QuadTreeItem.extend({parent:null,__ctor:function(parent,dx,dy,width,height){this._super.QuadTreeItem.__ctor();this.parent=parent;this.setFlags(DisplayElement.FLAG_FRAGMENT|QuadTreeItem.FLAG_CHILD);this.setType(parent.getType());this.bounds.set(parent.bounds);this.lbounds.set(parent.bounds);this.bounds.translate(dx,dy);this.lbounds.translate(dx,dy);this.bounds.resize(width,height);this.lbounds.resize(width,height)},translate:function(dx,dy){this.bounds.translate(dx,dy);this.lbounds.translate(dx,dy)}})},{"./display-element":8,"./quadtree-item":38}],11:[function(require,module,exports){(function(global){const C=require("./config");module.exports={area:null,viewport:null,debugHitbox:false,debugBounds:false,debugImage:false};global.px=function(value){return value*C.SCALE};global.dispose=function(obj,reason){if(!obj)return;if("dispose"in obj){obj.dispose(reason);return}if("__dtor"in obj)obj.__dtor()};if("AudioContext"in global)global.audioContext=new AudioContext;else global.audioContext=null;global.fetchd=function(url,options){return new Promise((resolve,reject)=>{if(!options)options={};if(!("responseType"in options))options.responseType="arraybuffer";var request=new XMLHttpRequest;request.open("GET",url,true);for(var i in options)request[i]=options[i];request.onload=function(){resolve(request.response)};request.onerror=function(){reject("Unable to fetch specified resource.")};request.send()})};global.fetchAudioBuffer=function(url){return new Promise((resolve,reject)=>{if(!global.audioContext){reject("AudioContext is not available.");return}fetchd(url).then(arrayBuffer=>audioContext.decodeAudioData(arrayBuffer)).then(audioBuffer=>resolve(audioBuffer)).catch(err=>reject(err))})};global.int=function(value){return~~value};global.bool=function(value){if(value===true||value===false)return value;if(value=="true")return true;if(value=="false")return false;return!!value};global.float=function(value){return parseFloat(value)};global.float2=function(value){return~~(value*100)/100};global.float3=function(value){return~~(value*1e3)/1e3};global.float4=function(value){return~~(value*1e4)/1e4};global.rad=function(value){return value*Math.PI/180};global.rand=function(){return int(Math.random()*65536)};global.randf=function(){return Math.random()};global.randrf=function(a,b){return Math.random()*(b-a)+a};global.randr=function(a,b){return~~(Math.random()*(b-a+1)+a)};global.randtf=function(a,b,n){var list=[];for(var i=0;i<n;i++)list.push(randrf(a,b));return list};global.hrnow=function(){return~~performance.now()};global.randvar=function(a,b){return function(){return randr(a,b)}};global.randitem=function(arr,a,b){if(!a)a=0;if(!b)b=arr.length-1;return function(){return arr[randr(a,b)]}};global.getLineSegmentIntersection=function(ls1_x1,ls1_y1,ls1_x2,ls1_y2,ls2_x1,ls2_y1,ls2_x2,ls2_y2){if(ls1_x1==ls2_x1&&ls1_y1==ls2_y1&&ls1_x2==ls2_x2&&ls1_y2==ls2_y2)return 0;let inf=2;var dyA=ls1_y2-ls1_y1;var dxA=ls1_x2-ls1_x1;var dyB=ls2_y2-ls2_y1;var dxB=ls2_x2-ls2_x1;if(dyA==0&&dyB==0){if(ls1_y1!=ls2_y1)return inf;var x1=Math.max(ls1_x1,ls2_x1);var x2=Math.min(ls1_x2,ls2_x2);if(x1>x2)return inf;return(x1-ls1_x1)/dxA}if(dxA==0&&dxB==0){if(ls1_x1!=ls2_x1)return inf;var y1=Math.max(ls1_y1,ls2_y1);var y2=Math.min(ls1_y2,ls2_y2);if(y1>y2)return inf;return(y1-ls1_y1)/dyA}if(dxA==0){var tA=(dyB*(ls1_x1-ls2_x1)+dxB*(ls2_y1-ls1_y1))/(dxB*dyA);if(0>tA||tA>1)return inf;var tB=(ls1_x1-ls2_x1)/dxB;if(0>tB||tB>1)return inf;return tA}var a=dyA*(ls2_x1-ls1_x1)+dxA*(ls1_y1-ls2_y1);var b=dyB*dxA-dxB*dyA;if(b==0)return inf;var tB=a/b;if(0>tB||tB>1)return inf;var tA=(dxB*tB+ls2_x1-ls1_x1)/dxA;if(0>tA||tA>1)return inf;return tA};global.lineSegmentIntersects=function(ls1_x1,ls1_y1,ls1_x2,ls1_y2,ls2_x1,ls2_y1,ls2_x2,ls2_y2){let t=getLineSegmentIntersection(ls1_x1,ls1_y1,ls1_x2,ls1_y2,ls2_x1,ls2_y1,ls2_x2,ls2_y2);return t>=0&&t<=1};global.rotatePoint=function(angle,x,y){if(Rin.typeOf(angle)=="object")return{x:x*angle.x+y*angle.y,y:y*angle.x-x*angle.y};else return{x:x*Math.cos(angle)+y*Math.sin(angle),y:y*Math.cos(angle)-x*Math.sin(angle)}};global.stepValue=function(value,minValue,maxValue,numSteps){return Math.round(numSteps*(value-minValue)/(maxValue-minValue))/numSteps*(maxValue-minValue)+minValue};global.alignValue=function(value,step){return Math.round(value/step)*step};require("./shims")}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./config":4,"./shims":36}],12:[function(require,module,exports){module.exports={PriorityQueue:require("./gx/priority-queue"),Boot:require("./gx/boot"),PointerHandler:require("./gx/pointer-handler"),KeyboardHandler:require("./gx/keyboard-handler"),ScreenControls:require("./gx/screen-controls"),VisualElement:require("./gx/visual-element"),VisualButton:require("./gx/visual-button"),DisplayList:require("./gx/display-list"),Vfx:require("./gx/vfx"),Layer:require("./gx/layer"),Layers:require("./gx/layers"),Gamepad:require("./gx/gamepad"),Variable:require("./gx/variable"),Sfx:require("./gx/sfx"),Background:require("./gx/background")}},{"./gx/background":13,"./gx/boot":14,"./gx/display-list":15,"./gx/gamepad":16,"./gx/keyboard-handler":17,"./gx/layer":18,"./gx/layers":19,"./gx/pointer-handler":20,"./gx/priority-queue":21,"./gx/screen-controls":22,"./gx/sfx":23,"./gx/variable":24,"./gx/vfx":25,"./gx/visual-button":26,"./gx/visual-element":27}],13:[function(require,module,exports){const DisplayElement=require("./../display-element");const QuadTreeItem=require("./../quadtree-item");const G=require("./../globals");const Background=module.exports=DisplayElement.extend({type:0,image:null,refX:0,refY:0,rateX:1,rateY:1,__ctor:function(type,x,y,width,height,image){this._super.DisplayElement.__ctor(width,height);this.type=type;this.image=image;this.refX=x;this.refY=y;this.setPosition(x,y,true);if(this.type==Background.FIXED)this.flags|=QuadTreeItem.FLAG_ALWAYS_SELECT},setScrollRates:function(sx,sy){this.rateX=sx;this.rateY=sy===undefined?sx:sy;return this},getImage:function(x,y){x=int((this.fAx*(this.baseX-this.bounds.x1)+(x-this.baseX))/this.image.width);y=int((this.fAy*(this.baseY-this.bounds.y1)+(y-this.baseY))/this.image.height);return this.getImageAt(x,y)},getImageAt:function(i,j){return this.image},drawImageSection:function(g,img,sx,sy,sw,sh,dx,dy,dw,dh){var r=img.rscale;g.drawImage(img.data,sx*r,sy*r,sw*r,sh*r,dx,dy,dw,dh)},draw:function(g){var viewport=G.viewport.getBounds();if(this.type==Background.FIXED){this.translate(viewport.x1-this.bounds.x1+this.refX,viewport.y1-this.bounds.y1+this.refY);g.drawImageResource(this.image,this.bounds.x1,this.bounds.y1);return}if(this.type==Background.TILED){var x1=Math.max(viewport.x1,this.bounds.x1);var y1=Math.max(viewport.y1,this.bounds.y1);var x2=Math.min(viewport.x2,this.bounds.x2);var y2=Math.min(viewport.y2,this.bounds.y2);var imgWidth=this.image.width;var imgHeight=this.image.height;var fullWidth=this.bounds.width();var fullHeight=this.bounds.height();this.fAx=(viewport.width()-fullWidth*this.rateX)/(viewport.width()-fullWidth);this.fBx=(1-this.fAx)*viewport.width();this.fAy=(viewport.height()-fullHeight*this.rateY)/(viewport.height()-fullHeight);this.fBy=(1-this.fAy)*viewport.height();var offsX=viewport.x2-this.bounds.x1;var offsY=viewport.y2-this.bounds.y1;offsX=-offsX+offsX*this.fAx+this.fBx+(x1-this.bounds.x1);offsY=-offsY+offsY*this.fAy+this.fBy+(y1-this.bounds.y1);offsX=int(offsX%imgWidth);offsY=int(offsY%imgHeight);this.baseX=x1;this.baseY=y1;var y=y1;for(;y+imgHeight<y2;y+=imgHeight-offsY,offsY=0){var x=x1;if(x+imgWidth<x2){this.drawImageSection(g,this.getImage(x,y),offsX,offsY,imgWidth-offsX,imgHeight-offsY,x,y,imgWidth-offsX,imgHeight-offsY);x+=imgWidth-offsX}for(;x+imgWidth<x2;x+=imgWidth){this.drawImageSection(g,this.getImage(x,y),0,offsY,imgWidth,imgHeight-offsY,x,y,imgWidth,imgHeight-offsY)}if(x<x2&&x==x1){var k=Math.min(imgWidth-offsX,x2-x);this.drawImageSection(g,this.getImage(x,y),offsX,offsY,k,imgHeight-offsY,x,y,k,imgHeight-offsY);x+=k}if(x<x2){this.drawImageSection(g,this.getImage(x,y),0,offsY,x2-x,imgHeight-offsY,x,y,x2-x,imgHeight-offsY)}}if(y<y2&&y==y1){var x=x1;var h=Math.min(imgHeight-offsY,y2-y);if(x+imgWidth<x2){this.drawImageSection(g,this.getImage(x,y),offsX,offsY,imgWidth-offsX,h,x,y,imgWidth-offsX,h);x+=imgWidth-offsX}for(;x+imgWidth<x2;x+=imgWidth){this.drawImageSection(g,this.getImage(x,y),0,offsY,imgWidth,h,x,y,imgWidth,h)}if(x<x2&&x==x1){var k=Math.min(imgWidth-offsX,x2-x);this.drawImageSection(g,this.getImage(x,y),offsX,offsY,k,h,x,y,k,h);x+=k}if(x<x2){this.drawImageSection(g,this.getImage(x,y),0,offsY,x2-x,h,x,y,x2-x,h)}y+=h}if(y<y2){var x=x1;if(x+imgWidth<x2){this.drawImageSection(g,this.getImage(x,y),offsX,0,imgWidth-offsX,y2-y,x,y,imgWidth-offsX,y2-y);x+=imgWidth-offsX}for(;x+imgWidth<x2;x+=imgWidth){this.drawImageSection(g,this.getImage(x,y),0,0,imgWidth,y2-y,x,y,imgWidth,y2-y)}if(x<x2&&x==x1){var k=Math.min(imgWidth-offsX,x2-x);this.drawImageSection(g,this.getImage(x,y),offsX,0,k,y2-y,x,y,k,y2-y);x+=k}if(x<x2){this.drawImageSection(g,this.getImage(x,y),0,0,x2-x,y2-y,x,y,x2-x,y2-y)}}return}if(this.type==Background.ABSOLUTE){g.drawImageResource(this.image,this.bounds.x1,this.bounds.y1);return}}});Background.ABSOLUTE=0;Background.FIXED=1;Background.TILED=2},{"./../display-element":8,"./../globals":11,"./../quadtree-item":38}],14:[function(require,module,exports){(function(global){const Class=require("@rsthn/rin/class");const PriorityQueue=require("./priority-queue");const System=require("../system");const Resources=require("../resources");const C=require("../config");const Boot=module.exports={modules:null,init:function(){this.modules=new PriorityQueue;global.main=function(){Resources.integerScaling=false;System.init({antialias:C.ANTIALIAS,fullscreen:false,background:C.BACKGROUND,targetScreenWidth:C.WIDTH,targetScreenHeight:C.HEIGHT,orientation:C.ORIENTATION,fps:C.FPS,minFps:C.MIN_FPS||15});Boot.startup()}},register:function(module){return this.modules.add(module)},unregister:function(module){this.modules.remove(module);this.modules.cleanup()},startup:function(){this.modules.forEachAsync((m,r)=>{if(m.onStartup(r)!==false)r()})},shutdown:function(){this.modules.forEachAsyncRev((m,r)=>{if(m.onShutdown(r)!==false)r()})}};Boot.Module=Class.extend({className:"Module",priority:50,__ctor:function(){Boot.register(this)},onStartup:function(next){},onShutdown:function(next){}});Boot.init()}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"../config":4,"../resources":43,"../system":44,"./priority-queue":21,"@rsthn/rin/class":35}],15:[function(require,module,exports){const List=require("../list");module.exports=List.extend({className:"DisplayList",orderingEnabled:false,area:null,__ctor:function(orderingEnabled){this._super.List.__ctor.apply(this,arguments);this.orderingEnabled=orderingEnabled||false},push:function(item){if(this.orderingEnabled&&this.count!=0){for(var i=this.top;i;i=i.next){if(item.hitbox.y2<i.value.hitbox.y2){this.insertBefore(i,item);item.container=this;item.node=i.prev;return this}}}this._super.List.push(item);item.container=this;item.node=this.bottom;return this},updatePosition:function(item){var node=item.node;if(this.orderingEnabled){if(node.prev&&node.prev.value.hitbox.y2>item.hitbox.y2){this.remove(item.node);this.push(item);return}if(node.next&&item.hitbox.y2>node.next.value.hitbox.y2){this.remove(item.node);this.push(item);return}}},forEach:function(fn){var ni;for(var i=this.top;i;i=ni){ni=i.next;if(fn(i.value,i,this)===false)return false}return true},forEachRev:function(fn){var ni;for(var i=this.bottom;i;i=ni){ni=i.prev;if(fn(i.value,i,this)===false)return false}return true},draw:function(g,reverse){this.curIndex=0;var _=this;g.pushMatrix();if(this.area!=null){g.translate(this.area.x1,this.area.y1)}if(reverse===true)this.forEachRev(function(v,i,l){v.__i=_.curIndex++;v.draw(g)});else this.forEach(function(v,i,l){v.__i=_.curIndex++;v.draw(g)});g.popMatrix()},update:function(dt){this.forEach(function(v,i,l){v.update(dt)})},find:function(filter){var item=null;this.forEach(function(v,i,l){if(filter(v)){item=v;return false}});return item},filter:function(filter,callback){var ni;for(var i=this.top;i;i=ni){ni=i.next;if(filter(i.value)!==false){var res=callback(i.value);if(res!==null)return res}}return null}})},{"../list":30}],16:[function(require,module,exports){const Layer=require("./layer");const VisualElement=require("./visual-element");const VisualButton=require("./visual-button");const G=require("../globals");module.exports=Layer.extend({className:"Gamepad",gamepad:null,gamepadHandler:[],spritesheet:null,width:0,height:0,spacing:0,paddingH:0,paddingV:0,debugBounds:false,__ctor:function(spritesheet,spacing,x,y,width,height,paddingV,paddingH){this.gamepad=new VisualElement(x,y);this.spritesheet=spritesheet;this.spacing=spacing;this.paddingV=paddingV||0;this.paddingH=paddingH||0;this.width=width;this.height=height},__dtor:function(){dispose(this.gamepad)},addButton:function(code,dx,dy,indexOff,indexOn,keyCode){var btn=new VisualButton((dx<0?this.width:0)+dx*this.spacing,(dy<0?this.height:0)+dy*this.spacing,this.spritesheet.getDrawable(indexOff),this.spritesheet.getDrawable(indexOn));btn.onChange=((state,pstate)=>{this.onButton(code,state,pstate)});btn.resizeHitboxBy(this.paddingH,this.paddingV);if(keyCode)btn.keyCode=keyCode;this.gamepad.addChild(btn)},onButton:function(code,state,pstate){if(!this.gamepadHandler.length)return;this.gamepadHandler[this.gamepadHandler.length-1].onButton(code,state,pstate)},draw:function(g){if(G.debugBounds){g.fillStyle("rgba(0,255,255,0.25)");g.fillRect(this.x,this.y,this.width,this.height)}this.gamepad.draw(g)}})},{"../globals":11,"./layer":18,"./visual-button":26,"./visual-element":27}],17:[function(require,module,exports){const PriorityQueue=require("./priority-queue");const Boot=require("./boot");const System=require("../system");module.exports=Boot.Module.create({handlers:null,__ctor:function(){this._super.Module.__ctor();this.handlers=new PriorityQueue},register:function(handler){try{this.handlers.add(handler)}catch(e){throw new Error("KeyboardHandler (register): "+e.message)}return handler},unregister:function(handler){try{this.handlers.remove(handler);this.handlers.cleanup()}catch(e){throw new Error("KeyboardHandler (unregister): "+e.message)}},onStartup:function(){System.onKeyboardEvent=((action,keyCode,keyEvtArgs)=>{const breakError={};try{this.handlers.forEach(h=>{if(h.onKeyboardEvent(action,keyCode,keyEvtArgs)===false)throw breakError})}catch(e){if(e!==breakError)throw e}})},onShutdown:function(){System.onKeyboardEvent=null}})},{"../system":44,"./boot":14,"./priority-queue":21}],18:[function(require,module,exports){const Class=require("@rsthn/rin/class");module.exports=Class.extend({className:"Layer",visible:true,active:true,time:0,__ctor:function(){this.time=0;this.init.apply(this,arguments)},__dtor:function(){},init:function(){},layerDraw:function(g){if(!this.visible)return;this.draw(g)},layerUpdate:function(dt){if(!this.active)return;this.time+=dt;this.update(dt)},activate:function(){},deactivate:function(){},draw:function(g){},update:function(dt){}})},{"@rsthn/rin/class":35}],19:[function(require,module,exports){const Class=require("@rsthn/rin/class");const Layers=module.exports=Class.extend({list:null,__ctor:function(){this.list=[];for(var i=0;i<Layers.NUM_LAYERS;i++)this.list.push(null)},__dtor:function(){},set:function(index,layer){if(index<0||index>=this.list.length)return;this.list[index]=layer},get:function(index){return index<0||index>=this.list.length?null:this.list[index]},draw:function(g){g.clear();try{for(var i=0;i<this.list.length;i++)if(this.list[i])this.list[i].layerDraw(g)}catch(e){if(e.message!="FRAME_END"){throw e}}},update:function(dt){dt/=1e3;try{for(var i=0;i<this.list.length;i++)if(this.list[i])this.list[i].layerUpdate(dt)}catch(e){if(e.message!="FRAME_END")throw e}}});Layers.INDEX_BACK0=0;Layers.INDEX_BACK1=1;Layers.INDEX_MAIN0=2;Layers.INDEX_MAIN1=3;Layers.INDEX_FRONT0=4;Layers.INDEX_FRONT1=5;Layers.INDEX_HUD0=6;Layers.INDEX_HUD1=7;Layers.NUM_LAYERS=Layers.INDEX_HUD1+1},{"@rsthn/rin/class":35}],20:[function(require,module,exports){const PriorityQueue=require("./priority-queue");const Boot=require("./boot");const System=require("../system");module.exports=Boot.Module.create({handlers:null,__ctor:function(){this._super.Module.__ctor();this.handlers=new PriorityQueue},register:function(handler){try{this.handlers.add(handler)}catch(e){throw new Error("PointerHandler (register): "+e.message)}return handler},unregister:function(handler){try{this.handlers.remove(handler);this.handlers.cleanup()}catch(e){throw new Error("PointerHandler (unregister): "+e.message)}},onStartup:function(){System.onPointerEvent=((action,p,pointers)=>{const breakError={};try{this.handlers.forEach(h=>{if(h.onPointerEvent(action,p,pointers)===false)throw breakError})}catch(e){if(e!==breakError)throw e}})},onShutdown:function(){System.onPointerEvent=null}})},{"../system":44,"./boot":14,"./priority-queue":21}],21:[function(require,module,exports){let Class=require("@rsthn/rin/class");module.exports=Class.extend({className:"PriorityQueue",queue:null,order:null,__ctor:function(){this.queue={}},add:function(object){if(object==null)return null;if(!("priority"in object))throw new Error("PriorityQueue: Object has no 'priority' property.");if(!(object.priority in this.queue)){this.queue[object.priority]={is_dirty:false,list:[]};this.order=Object.keys(this.queue).sort((a,b)=>a-b)}if(this.queue[object.priority].list.indexOf(object)===-1)this.queue[object.priority].list.push(object);return object},remove:function(object){if(object==null)return null;if(!("priority"in object))throw new Error("PriorityQueue: Object has no 'priority' property.");if(!(object.priority in this.queue))return object;var i=this.queue[object.priority].list.indexOf(object);if(i===-1)return object;this.queue[object.priority].is_dirty=true;this.queue[object.priority].list[i]=null;return object},cleanup:function(){for(var i in this.queue){var q=this.queue[i];if(q.is_dirty==false)continue;for(var j=0;j<q.list.length;j++){if(q.list[j]==null)q.list[j--].splice(1,0)}q.is_dirty=false}},forEach:function(callback){var is_dirty=false;var is_complete=false;for(var i=0;!is_complete&&i<this.order.length;i++){var list=this.queue[this.order[i]].list;for(var j=0;!is_complete&&j<list.length;j++){if(list[j]!=null){if(callback(list[j])===false)is_complete=true}if(list[j]==null)is_dirty=true}}if(is_dirty)this.cleanup()},forEachRev:function(callback){var is_dirty=false;var is_complete=false;for(var i=this.order.length-1;!is_complete&&i>=0;i--){var list=this.queue[this.order[i]].list;for(var j=list.length-1;!is_complete&&j>=0;j--){if(list[j]!=null){if(callback(list[j])===false)is_complete=true}if(list[j]==null)is_dirty=true}}if(is_dirty)this.cleanup()},forEachAsync:function(callback){var _=this;var is_dirty=false;var is_complete=false;var i=-1;var j=-1;var list=null;var next_j=function(){j++;if(!is_complete&&j<list.length){if(list[j]!=null){if(callback(list[j],next_j)===false)is_complete=true}if(list[j]==null)is_dirty=true;if(is_complete)next_j()}else next_i()};var next_i=function(){i++;if(!is_complete&&i<_.order.length){list=_.queue[_.order[i]].list;j=-1;next_j()}else{if(is_dirty)_.cleanup()}};next_i()},forEachRevAsync:function(callback){}})},{"@rsthn/rin/class":35}],22:[function(require,module,exports){const PointerHandler=require("./pointer-handler");const KeyboardHandler=require("./keyboard-handler");const System=require("../system");const ScreenControls=module.exports={priority:50,list:[],hoverEnabled:false,add:function(c){if(this.list.indexOf(c)===-1)this.list.push(c)},remove:function(c){var i=this.list.indexOf(c);if(i!==-1)this.list.splice(i,1)},setHoverEnabled:function(value){this.hoverEnabled=value},findTarget:function(x,y,filter){for(let i in this.list){if(!this.list[i])continue;if(this.list[i]instanceof Array){for(let j=0;j<this.list[i].length;j++){if(filter!=null&&filter(this.list[i][j])==false)continue;if(this.list[i][j].containsPoint(x,y))return this.list[i][j]}}else{if(filter!=null&&filter(this.list[i])==false)continue;if(this.list[i].containsPoint(x,y))return this.list[i]}}return null},onPointerEvent:function(action,p,pointers){let _continue=true;let tmp=null;switch(action){case System.EVT_POINTER_DOWN:if(p._ref!=null){tmp=p._ref;p._ref=null;tmp.deactivate(p)}tmp=this.findTarget(p.x,p.y);if(tmp!=null){(p._ref=tmp).activate(p);_continue=false}break;case System.EVT_POINTER_DRAG_START:if(p._ref!=null)_continue=false;break;case System.EVT_POINTER_DRAG_MOVE:if(this.hoverEnabled){if(p._refh!=null){if(p._refh.containsPoint(p.x,p.y)){}else{tmp=p._refh;p._refh=null;tmp.hover(false,p);tmp=this.findTarget(p.x,p.y,i=>"hover"in i);if(tmp!=null)(p._refh=tmp).hover(true,p)}}else{tmp=this.findTarget(p.x,p.y,i=>"hover"in i);if(tmp!=null)(p._refh=tmp).hover(true,p)}}if(p._ref!=null){if(p._ref.containsPoint(p.x,p.y)||p._ref.focusLock==true){p._ref.update(p.x,p.y,p);_continue=false}else{tmp=p._ref;p._ref=null;tmp.deactivate(p);tmp=this.findTarget(p.x,p.y);if(tmp!=null){(p._ref=tmp).activate(p);_continue=false}}}else{tmp=this.findTarget(p.x,p.y);if(tmp!=null){(p._ref=tmp).activate(p);_continue=false}}break;case System.EVT_POINTER_MOVE:if(this.hoverEnabled){if(p._refh!=null){if(p._refh.containsPoint(p.x,p.y)){}else{tmp=p._refh;p._refh=null;tmp.hover(false,p);tmp=this.findTarget(p.x,p.y,i=>"hover"in i);if(tmp!=null)(p._refh=tmp).hover(true,p)}}else{tmp=this.findTarget(p.x,p.y,i=>"hover"in i);if(tmp!=null)(p._refh=tmp).hover(true,p)}}if(p._ref==null)break;if(p._ref.containsPoint(p.x,p.y)||p._ref.focusLock==true){p._ref.update(p.x,p.y,p);_continue=false}else{tmp=p._ref;p._ref=null;tmp.deactivate(p)}break;case System.EVT_POINTER_DRAG_STOP:if(p._ref!=null)_continue=false;break;case System.EVT_POINTER_UP:if(p._ref!=null){tmp=p._ref;p._ref=null;tmp.deactivate(p);_continue=false}break}return _continue},onKeyboardEvent:function(action,keyCode,keyArgs){switch(action){case System.EVT_KEY_DOWN:for(var i in this.list){if(!this.list[i])continue;if(this.list[i]instanceof Array){for(var j=0;j<this.list[i].length;j++){if(this.list[i][j].keyCode==keyCode){this.list[i][j].activate({});j=-1;break}}if(j==-1)break}else{if(this.list[i].keyCode==keyCode){this.list[i].activate({});break}}}break;case System.EVT_KEY_UP:for(var i in this.list){if(!this.list[i])continue;if(this.list[i]instanceof Array){for(var j=0;j<this.list[i].length;j++){if(this.list[i][j].keyCode==keyCode){this.list[i][j].deactivate({});j=-1;break}}if(j==-1)break}else{if(this.list[i].keyCode==keyCode){this.list[i].deactivate({});break}}}break}}};PointerHandler.register(ScreenControls);KeyboardHandler.register(ScreenControls)},{"../system":44,"./keyboard-handler":17,"./pointer-handler":20}],23:[function(require,module,exports){const Boot=require("./boot");const System=require("../system");module.exports=Boot.Module.create({time:0,onStartup:function(){System.updateQueueAdd(this)},onShutdown:function(){System.updateQueueRemove(this)},update:function(dt){this.time+=dt},play:function(name){}})},{"../system":44,"./boot":14}],24:[function(require,module,exports){const Class=require("@rsthn/rin/class");const Easing=require("../easing");module.exports=Class.extend({className:"Variable",enabled:false,easing:null,callback:null,time:0,dt:0,defaultDuration:0,duration:0,startValue:0,endValue:0,value:null,__ctor:function(value,easing,duration){this.startValue=this.endValue=this.value=value||0;this.ivalue=0;this.easing=easing||Easing.Linear.IN;this.defaultDuration=this.duration=duration||.5},isFinished:function(){return this.enabled==false},setEasing:function(easing){this.easing=easing;return this},restart:function(){this.time=this.dt=0;this.enabled=true;this.value=this.getValueAt(0);this.ivalue=0;return this},onFinished:function(callback){this.callback=callback;return this},getValueAt:function(t){return this.easing(t)*(this.endValue-this.startValue)+this.startValue},range:function(startValue,endValue,duration,callback){this.startValue=startValue;this.endValue=endValue;this.duration=duration||this.defaultDuration;this.callback=callback||this.callback;return this.restart()},delta:function(deltaValue,duration,callback){return this.range(this.value,this.endValue+deltaValue,duration,callback)},set:function(value){this.enabled=false;this.value=value;this.ivalue=0;return this},update:function(dt){if(this.enabled==false)return;if(this.duration!=-1&&this.time==this.duration){this.enabled=false;this.ivalue=0;if(this.callback!=null)this.callback();return}const ltime=this.time;this.time+=dt;if(this.duration!=-1&&this.time>this.duration)this.time=this.duration;this.dt=this.time-ltime;const x0=ltime;const x1=this.time;const y0=this.duration!=-1?this.getValueAt(x0/this.duration):this.getValueAt(0);const y1=this.duration!=-1?this.getValueAt(x1/this.duration):this.getValueAt(0);const dx=x1-x0;const dy=y1-y0;this.ivalue=dy*.5*(dx+2*x0)+y0*dx-dy*x0;this.value=y1}})},{"../easing":9,"@rsthn/rin/class":35}],25:[function(require,module,exports){const VisualElement=require("./visual-element");const Variable=require("./variable");const Vfx=module.exports=VisualElement.extend({className:"Vfx",_duration:null,_angle:null,_scale:null,_alpha:null,callback:null,__ctor:function(x,y,anim){this._super.VisualElement.__ctor(x,y,anim);if("onFinished"in anim)anim.onFinished(()=>this.finished());if(Vfx.targetDisplayList!=null)Vfx.targetDisplayList.push(this)},finished:function(){if(this.callback)this.callback();dispose(this)},onFinished:function(callback){this.callback=callback;return this},duration:function(seconds){this._duration=new Variable(0,Easing.Linear.IN,seconds);this._duration.onFinished(()=>this.finished());this._duration.animate(0,seconds,seconds);return this},rotate:function(startValue,endValue,easing){this._angle=new Variable(0,easing||Easing.Linear.IN);this._angle.animate(startValue,endValue,this._duration.endValue);return this},scale:function(startValue,endValue,easing){this._scale=new Variable(0,easing||Easing.Linear.IN);this._scale.animate(startValue,endValue,this._duration.endValue);return this},alpha:function(startValue,endValue,easing){this._alpha=new Variable(0,easing||Easing.Linear.IN);this._alpha.animate(startValue,endValue,this._duration.endValue);return this},applyTransforms:function(g){if(this._angle!=null)g.rotate(this._angle.value);if(this._scale!=null)g.scale(this._scale.value,this._scale.value);if(this._alpha!=null)g.alpha(this._alpha.value)},lupdate:function(dt){if(this._duration!=null)this._duration.update(dt);if(this._angle!=null)this._angle.update(dt);if(this._scale!=null)this._scale.update(dt);if(this._alpha!=null)this._alpha.update(dt)}});Vfx.targetDisplayList=null},{"./variable":24,"./visual-element":27}],26:[function(require,module,exports){const VisualElement=require("./visual-element");const ScreenControls=require("./screen-controls");const Controls=require("../controls");const G=require("../globals");module.exports=VisualElement.extend({className:"VisualButton",keyCode:0,init:function(x,y,unpressedImg,pressedImg=null,is_center=true){this.img=null;if(!pressedImg)pressedImg=unpressedImg;if(is_center===false)this.button=new Controls.Button(0,0,0,0,unpressedImg,pressedImg);else this.button=new Controls.Button(0,0,-unpressedImg.width*.5,-unpressedImg.height*.5,unpressedImg,pressedImg);this.button.onChange=((status,pstatus)=>{this.onChange(status,pstatus);if(status==0&&pstatus==1)this.onTap()})},setImage:function(unpressedImg,pressedImg){if(!pressedImg)pressedImg=unpressedImg;this.button.unpressedImg=unpressedImg;this.button.pressedImg=pressedImg},resizeHitboxBy:function(dx,dy){this.button.hbounds.resizeBy(dx,dy);return this},update:function(dt){if(arguments.length==2){return this.update_button(arguments[0],arguments[1])}if(!this.getVisible()||!this.getEnabled())return;if(this.anim!=null)this.anim.update(dt*1e3);this.lupdate(dt)},update_button:function(x,y){return this.button.update(x-this.getX(),y-this.getY())},onAdded:function(){ScreenControls.add(this)},onRemoved:function(){ScreenControls.remove(this)},activate:function(pointer){this.button.activate(pointer);pointer._ref=this},deactivate:function(pointer){this.button.deactivate(pointer);pointer._ref=null},containsPoint:function(x,y){if(!this.getEnabled())return false;const p=this.reverseTransform({x:x,y:y});return this.button.containsPoint(p.x,p.y)},ldraw:function(g){this.button.draw(g);if(G.debugHitbox){g.fillStyle("rgba(255,0,0,0.25)");g.fillRect(this.button.hbounds.x1,this.button.hbounds.y1,this.button.hbounds.width(),this.button.hbounds.height())}},onChange:function(status,pstatus){},onTap:function(){}})},{"../controls":5,"../globals":11,"./screen-controls":22,"./visual-element":27}],27:[function(require,module,exports){const Class=require("@rsthn/rin/class");const Rect=require("../rect");const G=require("../globals");const C=require("../config");module.exports=Class.extend({className:"VisualElement",scale:1,x:0,y:0,width:0,height:0,img:null,t:0,type:0,inherited_enabled:true,enabled:true,inherited_visible:true,visible:true,debugHitbox:false,highlight:false,anim:null,container:null,node:null,parent:null,children:null,related:null,isRelated:false,hitbox:null,sensebox:null,undisposable:false,__ctor:function(x,y,drawable){this.x=x;this.y=y;this.img=drawable||null;if(this.img){this.width=this.img.width;this.height=this.img.height}else{this.width=C.TILE_SIZE;this.height=C.TILE_SIZE}this.hitbox=Rect.alloc();this.hitbox.resize(this.width,this.height);this.hitbox.translate(this.x-this.hitbox.x1,this.y-this.hitbox.y1);this.hitbox.translate(-this.width*.5,-this.height*.5);this.children=[];this.init.apply(this,arguments)},__dtor:function(){if(this.undisposable)return;dispose(this.hitbox);if(this.sensebox){this.sensebox=null;dispose(this.sensebox)}this.remove();if(this.related!=null){var tmp=this.related;this.related=null;for(var i=0;i<tmp.length;i++)dispose(tmp[i])}var tmp=this.children;for(var i=0;i<tmp.length;i++)dispose(tmp[i])},init:function(){},resize:function(width,height){this.width=width;this.height=height;this.resizeHitbox(width,height)},resizeHitbox:function(width,height,normalized){if(normalized===true){width*=this.width;height*=this.height}this.hitbox.zero();this.hitbox.translate(this.x,this.y);this.hitbox.translate(.5*this.width,.5*this.height);this.hitbox.resize(width,height)},getX:function(){return this.x+(this.parent!=null?this.parent.getX():0)},getY:function(){return this.y+(this.parent!=null?this.parent.getY():0)},reverseTransform:function(pos){if(this.parent!=null&&this.isRelated==false)this.parent.reverseTransform(pos);pos.x-=this.x;pos.y-=this.y;pos.x/=this.scale;pos.y/=this.scale;return pos},setScale:function(value){this.scale=value;return this},getEnabled:function(){return this.enabled&&this.inherited_enabled},setEnabled:function(value,inherited){if(inherited===true)this.inherited_enabled=value;else this.enabled=value;value=this.getEnabled();for(var i=0;i<this.children.length;i++)this.children[i].setEnabled(value,true);return this},getVisible:function(){return this.visible&&this.inherited_visible},setVisible:function(value,inherited){if(inherited===true)this.inherited_visible=value;else this.visible=value;value=this.getVisible();for(var i=0;i<this.children.length;i++)this.children[i].setVisible(value,true);return this},setAnim:function(anim){this.anim=anim;this.anim.target=this;return this},resetAnim:function(anim){if(anim)this.setAnim(anim);if(this.anim!=null)this.anim.reset();for(var i=0;i<this.children.length;i++)this.children[i].resetAnim()},addTo:function(list){list.push(this);return this},addRelated:function(elem){if(this.related==null)this.related=[];elem.parent=this;elem.isRelated=true;this.related.push(elem);return elem},addChild:function(elem){if(elem==null)return elem;elem.parent=this;elem.isRelated=false;this.children.push(elem);elem.setEnabled(this.getEnabled(),true);elem.onAdded();return elem},removeRelated:function(elem){if(elem==null||elem.parent!==this||this.related==null)return elem;var i=this.related.indexOf(elem);if(i===-1)return elem;this.related.splice(i,1);return elem},removeChild:function(elem){if(elem==null||elem.parent!==this)return elem;var i=this.children.indexOf(elem);if(i===-1)return elem;this.children.splice(i,1);elem.onRemoved();return elem},remove:function(){if(this.container!=null){this.container.remove(this.node);this.container=null}if(this.parent!=null){this.parent.removeRelated(this);this.parent.removeChild(this);this.parent=null}return this},updatePosition:function(){if(this.container!=null)this.container.updatePosition(this);if(this.related!=null){for(var i=0;i<this.related.length;i++){if(this.related[i].container!=null)this.related[i].container.updatePosition(this.related[i])}}},containsPoint:function(x,y){return this.x<=x&&x<this.x+this.width&&this.y<=y&&y<this.y+this.height},setPosition:function(x,y){if(arguments.length==1)return this.setPosition(x.x,x.y);this.translate(x-this.x,y-this.y);return this},translate:function(dx,dy){if(this.related!=null){for(var i=0;i<this.related.length;i++)this.related[i].translate(dx,dy)}this.x+=dx;this.y+=dy;this.hitbox.translate(dx,dy);if(this.sensebox)this.sensebox.translate(dx,dy)},draw:function(g){if(!this.getVisible())return;g.pushMatrix();g.pushAlpha();g.translate(this.x,this.y);g.scale(this.scale,this.scale);if(this.anim!=null){if("dx"in this.anim.data)g.translate(this.anim.data.dx,this.anim.data.dy);if("sx"in this.anim.data)g.scale(this.anim.data.sx,this.anim.data.sy);if("alpha"in this.anim.data)g.alpha(this.anim.data.alpha)}this.applyTransforms(g);if(this.img!=null){g.pushMatrix();g.translate(-(this.img.width>>1),-(this.img.height>>1));this.img.draw(g,0,0);if(G.debugBounds){g.strokeStyle("yellow");g.strokeRect(0,0,this.width,this.height)}g.popMatrix()}this.ldraw(g);for(var i=0;i<this.children.length;i++)this.children[i].draw(g);this.onDrawn(g);g.popMatrix();g.popAlpha();if(G.debugImage){g.fillStyle("rgba(255,255,255,0.1)");g.fillRect(this.x,this.y,this.width,this.height)}if(G.debugHitbox||this.debugHitbox){if(this.sensebox){g.fillStyle("rgba(255,255,0,0.2)");g.fillRect(int(this.sensebox.x1),int(this.sensebox.y1),int(this.sensebox.width()),int(this.sensebox.height()))}if(!this.type)g.fillStyle("rgba(255,255,255,0.1)");else g.fillStyle("rgba(0,255,255,0.4)");if(this.highlight){g.fillStyle("rgba(255,0,0,0.5)");this.highlight=false}g.fillRect(int(this.hitbox.x1),int(this.hitbox.y1),int(this.hitbox.width()),int(this.hitbox.height()))}},update:function(dt){if(!this.getEnabled())return;if(this.anim!=null)this.anim.update(dt);for(var i=0;i<this.children.length;i++)this.children[i].update(dt);this.lupdate(dt);this.onUpdated(dt)},onAdded:function(){},onRemoved:function(){},applyTransforms:function(g){},ldraw:function(g){},lupdate:function(dt){},onDrawn:function(g){},onUpdated:function(dt){}})},{"../config":4,"../globals":11,"../rect":41,"@rsthn/rin/class":35}],28:[function(require,module,exports){module.exports={BACKSPACE:8,TAB:9,ENTER:13,ESC:27,SPACE:32,PGUP:33,PGDN:34,END:35,HOME:36,INS:45,DEL:46,LEFT:37,UP:38,RIGHT:39,DOWN:40,NUM_PLUS:107,NUM_MINUS:109,NUM_ASTERISK:106,NUM_SLASH:111,NUM_DOT:110,NUM_0:96,NUM_1:97,NUM_2:98,NUM_3:99,NUM_4:100,NUM_5:101,NUM_6:102,NUM_7:103,NUM_8:104,NUM_9:105,D0:48,D1:49,D2:50,D3:51,D4:52,D5:53,D6:54,D7:55,D8:56,D9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90}},{}],29:[function(require,module,exports){const Class=require("@rsthn/rin/class");const Recycler=require("./recycler");const Linkable=module.exports=Class.extend({className:"Linkable",prev:null,next:null,value:null,__ctor:function(value){this.value=value;this.clear()},__reinit:function(value){this.value=value;this.clear();return this},__dtor:function(){},clear:function(){this.next=this.prev=null;return this},linkAfter:function(item){this.prev=item;this.next=item?item.next:null;if(item){if(item.next)item.next.prev=this;item.next=this}},linkBefore:function(item){this.prev=item?item.prev:null;this.next=item;if(item){if(item.prev)item.prev.next=this;item.prev=this}},unlink:function(){if(this.prev)this.prev.next=this.next;if(this.next)this.next.prev=this.prev;return this.clear()}});Recycler.attachTo(Linkable)},{"./recycler":42,"@rsthn/rin/class":35}],30:[function(require,module,exports){const Class=require("@rsthn/rin/class");const Linkable=require("./linkable");const List=module.exports=Class.extend({className:"List",top:null,bottom:null,count:0,__ctor:function(){this.top=null;this.bottom=null;this.count=0},__dtor:function(){this.reset()},clear:function(){var item,nextItem;for(item=this.top;item!=null;item=nextItem){nextItem=item.next;dispose(item.value);dispose(item)}this.top=this.bottom=null;this.count=0;return this},reset:function(){var item,nextItem;for(item=this.top;item!=null;item=nextItem){nextItem=item.next;dispose(item)}this.top=this.bottom=null;this.count=0;return this},getAt:function(index){var item=null;for(item=this.top;item&&index--;item=item.next);return item!=null?item.value:null},getNodeAt:function(index){var item=null;for(item=this.top;item&&index--;item=item.next);return item},sgetNode:function(value){for(var item=this.top;item;item=item.next)if(item.value==value)return item;return null},remove:function(item){if(!item)return null;if(!item.prev)this.top=item.next;if(!item.next)this.bottom=item.prev;this.count--;var value=item.unlink().value;dispose(item);return value},insertBefore:function(ref,value){if(!ref)return this;var item=Linkable.alloc(value);item.linkBefore(ref);if(ref==this.top)this.top=item;this.count++;return this},insertAfter:function(ref,value){if(!ref)return this;var item=Linkable.alloc(value);item.linkAfter(ref);if(ref==this.bottom)this.bottom=item;this.count++;return this},unshift:function(value){var item=Linkable.alloc(value);item.linkBefore(this.top);if(!this.bottom)this.bottom=item;this.top=item;this.count++;return this},shift:function(){var item=this.top;if(!item)return null;if(!(this.top=item.next))this.bottom=null;this.count--;var value=item.unlink().value;dispose(item);return value},push:function(value){var item=Linkable.alloc(value);item.linkAfter(this.bottom);if(!this.top)this.top=item;this.bottom=item;this.count++;return this},pop:function(){var item=this.bottom;if(!item)return null;if(!(this.bottom=item.prev))this.top=null;this.count--;var value=item.unlink().value;dispose(item);return value},append:function(list){for(var i=list.top;i;i=i.next)this.push(i.value);return this}})},{"./linkable":29,"@rsthn/rin/class":35}],31:[function(require,module,exports){const System=require("./system");const Log=module.exports={enabled:false,data:[],count:0,maxsize:30,debugEcho:false,color:"#fff",background:"#000",write:function(msg){if(!this.enabled)return;this.data.push(msg);this.count++;while(this.data.length>this.maxsize)this.data.shift();if(this.debugEcho)console.debug(this.count+": "+msg)},clear:function(){this.data=[];this.count=0},enable:function(x,y,fontSize,showFps,showIndex){if(this.enabled)return;this.enabled=true;if(!x)x=0;if(!y)y=0;if(!fontSize)fontSize=12;if(showFps===false)y-=16;System.drawQueueAdd({draw:function(g){g.font("normal "+fontSize+"px 'Bitstream Vera Sans Mono', monospace");var _time=(System.perf.lastTime-System.perf.startTime)/1e3;var _frames=System.perf.numFrames;var s="";if(showFps!==false){s="FPS: "+(_frames/_time).toFixed(2)+", update: "+(System.perf.updateTime/_frames).toFixed(2)+", draw: "+(System.perf.drawTime/_frames).toFixed(2);if(Log.background){g.fillStyle(Log.background);g.fillRect(x+10-2,y+10-2,g.measureText(s)+4,fontSize+4)}g.fillStyle(Log.color);g.fillText(s,x+10,y+20)}for(var i=0;i<Log.data.length;i++){s=(showIndex!==false?"#"+(Log.count-Log.data.length+i+1)+": ":"> ")+Log.data[i];if(Log.background){g.fillStyle(Log.background);g.fillRect(x+10-2,y+10+16*(i+1)-2,g.measureText(s)+4,fontSize+4)}g.fillStyle(Log.color);g.fillText(s,x+10,y+20+16*(i+1))}}})}}},{"./system":44}],32:[function(require,module,exports){(function(global){global.cherry=global.Cherry={G:require("./globals"),C:require("./config"),Matrix:require("./matrix"),Rect:require("./rect"),Vec2:require("./vec2"),Perf:require("./perf"),Log:require("./log"),Timer:require("./timer"),Recycler:require("./recycler"),Linkable:require("./linkable"),List:require("./list"),Canvas:require("./canvas"),KeyCodes:require("./keycodes"),System:require("./system"),Wrappers:require("./wrappers"),Resources:require("./resources"),QuadTreeItem:require("./quadtree-item"),QuadTreeNode:require("./quadtree-node"),QuadTree:require("./quadtree"),DisplayElement:require("./display-element"),Viewport:require("./viewport"),World:require("./world"),Easing:require("./easing"),Anim:require("./anim"),Controls:require("./controls"),Gx:require("./gx")}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./anim":2,"./canvas":3,"./config":4,"./controls":5,"./display-element":8,"./easing":9,"./globals":11,"./gx":12,"./keycodes":28,"./linkable":29,"./list":30,"./log":31,"./matrix":33,"./perf":37,"./quadtree":40,"./quadtree-item":38,"./quadtree-node":39,"./rect":41,"./recycler":42,"./resources":43,"./system":44,"./timer":45,"./vec2":46,"./viewport":47,"./world":48,"./wrappers":49}],33:[function(require,module,exports){arguments[4][1][0].apply(exports,arguments)},{dup:1}],34:[function(require,module,exports){let Rin=module.exports={};Rin.invokeLater=function(fn){if(fn)setTimeout(function(){fn()},10)};Rin.typeOf=function(o){if(o instanceof Array)return"array";if(o===null)return"null";return(typeof o).toString().toLowerCase()};Rin.isArrayOrObject=function(o){switch(Rin.typeOf(o)){case"array":case"object":return true}return false};Rin.clone=function(elem){var o;if(Rin.typeOf(elem)=="array"){o=[];for(let i=0;i<elem.length;i++)o.push(Rin.clone(elem[i]))}else if(Rin.typeOf(elem)=="object"){o={};for(let i in elem)o[i]=Rin.clone(elem[i])}else{o=elem}return o};Rin.merge=function(output,...objs){if(Rin.typeOf(output)=="array"){for(let i=0;i<objs.length;i++){let arr=objs[i];if(Rin.typeOf(arr)!="array"){output.push(arr)}else{for(let j=0;j<arr.length;j++){output.push(Rin.clone(arr[j]))}}}}else if(Rin.typeOf(output)=="object"){for(let i=0;i<objs.length;i++){let obj=objs[i];if(Rin.typeOf(obj)!="object")continue;for(let field in obj){if(Rin.isArrayOrObject(obj[field])){if(field in output)Rin.merge(output[field],obj[field]);else output[field]=Rin.clone(obj[field])}else output[field]=obj[field]}}}return output};Rin.override=function(output,...objs){for(let i=0;i<objs.length;i++){for(let j in objs[i]){output[j]=objs[i][j]}}return output};Rin.partialCompare=function(full,partial){if(full==null||partial==null)return false;if(full===partial)return true;for(var i in partial){if(full[i]!=partial[i])return false}return true};Rin.arrayFind=function(arr,o,getObject){for(var i=0;arr&&i<arr.length;i++){if(this.partialCompare(arr[i],o))return getObject?arr[i]:i}return getObject?null:false};Rin.indexOf=function(container,value){for(let i in container){if(container[i]==value)return i}return-1};Rin.escape=function(str){return(str+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};Rin.ensureTypeOf=function(m,o){if(!o||!m||o instanceof m)return o;if(o.isInstanceOf&&m.prototype.className){if(o.isInstanceOf(m.prototype.className))return o}return new m(o)};Rin.serialize=function(o){return JSON.stringify(o)};Rin.deserialize=function(s){return JSON.parse(s)}},{}],35:[function(require,module,exports){let Rin=require("./alpha");module.exports=Class=function(){};Class._class=Class;Class._super={};Class.prototype.className="Class";Class.prototype.__ctor=function(){};Class.prototype.__init=function(){};Class.prototype.isInstanceOf=function(className){className=Rin.typeOf(className)=="string"?className:className.prototype?className.prototype.className:className.constructor.prototype.className;return className in this._super?true:this.className==className};Class.prototype._initSuperRefs=function(){var _super=this.constructor._super;var _newSuper={};for(let i in _super){let o={};let _prot=_super[i].prototype;for(let j in _prot){if(Rin.typeOf(_prot[j])=="function")o[j]=_prot[j].bind(this)}_newSuper[i]=o}this._super=_newSuper};Class.inherit=function(proto){var self=this._class;var _super=self._super;var _class=self._class;if(Rin.typeOf(proto)=="function"){for(let i in proto._class)if(!/^[A-Z]/.test(i))self[i]=proto._class[i];Rin.override(self.prototype,proto._class.prototype);Rin.override(_super,proto._class._super);if(proto._class.prototype.className)_super[proto._class.prototype.className]=proto._class}else{Rin.override(self.prototype,proto)}self._super=_super;self._class=_class;return self};Class.prototype._extend=function(base,protos){var _class=function(...args){this._initSuperRefs();this.__ctor.apply(this,args)};_class._class=_class;_class._super={};Class.inherit.call(_class,base);delete _class.prototype.className;for(let i=0;i<protos.length;i++)_class.inherit(protos[i]);delete _class._super.Class;if("classInit"in _class.prototype)_class.prototype.classInit();return _class};Class.extend=function(...protos){return this._class.prototype._extend(this,protos)};Class.create=function(proto){return new(this.extend(proto))}},{"./alpha":34}],36:[function(require,module,exports){},{}],37:[function(require,module,exports){let Perf=module.exports=function(accumSize,expectedValue){this.data=[];this.accumSize=accumSize;this.expectedValue=expectedValue;this.stdSum=0;this.stdCount=0};Perf.prototype.begin=function(){this.startTime=performance.now()};Perf.prototype.end=function(){this.feed(performance.now()-this.startTime)};Perf.prototype.feed=function(value){this.data.push(value);if(this.data.length!=this.accumSize)return;this.report();this.data=[]};Perf.prototype.report=function(returnString){var min=null;var max=null;var avg=0;var std=0;for(var i=0;i<this.data.length;i++){min=min===null?this.data[i]:Math.min(min,this.data[i]);max=max===null?this.data[i]:Math.max(max,this.data[i]);avg+=this.data[i]}avg/=this.data.length;var e=this.expectedValue!==undefined?this.expectedValue:avg;for(var i=0;i<this.data.length;i++)std+=Math.pow(this.data[i]-e,2);std=Math.sqrt(std/this.data.length);this.stdSum+=std;this.stdCount++;var out="N: "+this.stdCount+", MIN: "+min+", MAX: "+max+", AVG: "+avg.toFixed(2)+(this.expectedValue!==undefined?", E: "+this.expectedValue:"")+", STDDEV: "+std.toFixed(2)+", AVG_STDDEV: "+(this.stdSum/this.stdCount).toFixed(2);this.min=min;this.max=max;this.avg=avg;this.std=std;if(returnString===true)return out;console.log(out)}},{}],38:[function(require,module,exports){const Class=require("@rsthn/rin/class");const Rect=require("./rect");const QuadTreeItem=module.exports=Class.extend({className:"QuadTreeItem",insertionBounds:null,lastBounds:null,bounds:null,lbounds:null,type:0,zindex:0,visible:true,flags:0,numRefNodes:0,__ctor:function(){this.insertionBounds=Rect.alloc();this.lastBounds=Rect.alloc();this.bounds=Rect.alloc();this.lbounds=Rect.alloc();this.numRefNodes=0;this.zindex=0;this.flags=QuadTreeItem.FLAG_INITIAL;this.type=0;this.visible=true},__reinit:function(){this.insertionBounds.zero();this.lastBounds.zero();this.bounds.zero();this.lbounds.zero();this.numRefNodes=0;this.zindex=0;this.flags=QuadTreeItem.FLAG_INITIAL;this.type=0;this.visible=true;this.tag=null},__dtor:function(){},setFlags:function(value){this.flags|=value},clearFlags:function(value){this.flags&=~value},getFlags:function(value){return this.flags&value},setTag:function(tag){this.tag=tag},getTag:function(){return this.tag},setZIndex:function(value){this.zindex=value;return this},getZIndex:function(){return this.zindex},notifyInserted:function(){this.flags|=QuadTreeItem.FLAG_ATTACHED;this.insertionBounds.set(this.getBounds());if(this.flags&QuadTreeItem.FLAG_INITIAL){this.flags&=~QuadTreeItem.FLAG_INITIAL;this.lastBounds.set(this.getBounds())}},notifyRemoved:function(){this.flags&=~QuadTreeItem.FLAG_ATTACHED},notifyPosition:function(){this.lastBounds.set(this.getBounds())},getInsertionBounds:function(){return this.insertionBounds},getLastBounds:function(){return this.lastBounds},getBounds:function(){return this.bounds},getLBounds:function(){return this.lbounds},setType:function(type){this.type=type;return this},getType:function(){return this.type},setVisible:function(value){this.visible=value;return this},getVisible:function(){return this.visible}});QuadTreeItem.FLAG_QUEUED=1;QuadTreeItem.FLAG_ATTACHED=2;QuadTreeItem.FLAG_SELECTED=4;QuadTreeItem.FLAG_INITIAL=8;QuadTreeItem.FLAG_ALWAYS_SELECT=16;QuadTreeItem.FLAG_CHILD=32;QuadTreeItem.FLAG_USERDEF=64},{"./rect":41,"@rsthn/rin/class":35}],39:[function(require,module,exports){require("./globals");const Class=require("@rsthn/rin/class");const Rect=require("./rect");const QuadTreeItem=require("./quadtree-item");const QuadTreeNode=module.exports=Class.extend({className:"QuadTreeNode",extents:null,numItems:0,insertionPoint:null,subNode:null,isDirty:false,__ctor:function(x1,y1,x2,y2){this.numItems=0;this.isDirty=false;this.insertionPoint=null;this.subNode=null;this.extents=Rect.alloc(x1,y1,x2,y2)},__dtor:function(){},destroy:function(list){if(this.subNode!=null){for(var i=0;i<4;i++)this.subNode[i].destroy(list)}else{var j=null;for(var i=this.insertionPoint;i&&this.numItems--;i=j){j=i.next;var k=list.remove(i);k.notifyRemoved();k.numRefNodes--;if(k.numRefNodes==0)dispose(k)}}dispose(this)},getExtents:function(){return this.extents},addItem:function(item,list,capacity){if(!item.getBounds().intersects(this.extents))return false;if(this.subNode!=null){var result=false;for(var i=0;i<4;i++)result|=this.subNode[i].addItem(item,list,capacity);if(result){this.isDirty=true;this.numItems++}return result}if(this.numItems<capacity){if(this.insertionPoint==null){list.push(item);this.insertionPoint=list.bottom}else list.insertAfter(this.insertionPoint,item);this.isDirty=true;this.numItems++;item.numRefNodes++;item.notifyInserted();return true}if(this.extents.width()<16||this.extents.height()<16){console.log("Error: Unable to split node any further. Current size is "+this.extents.width()+" x "+this.extents.height());return false}this.subNode=[new QuadTreeNode(this.extents.x1,this.extents.y1,this.extents.cx,this.extents.cy),new QuadTreeNode(this.extents.cx,this.extents.y1,this.extents.x2,this.extents.cy),new QuadTreeNode(this.extents.x1,this.extents.cy,this.extents.cx,this.extents.y2),new QuadTreeNode(this.extents.cx,this.extents.cy,this.extents.x2,this.extents.y2)];var n=this.numItems;this.numItems=0;for(var i=0;i<n;i++){var tmp=this.insertionPoint.next;this.insertionPoint.value.numRefNodes--;if(!this.addItem(this.insertionPoint.value,list,capacity)){console.log("Error: Shouldn't have happened. Unable to insert item on a sub-node of a just-split node.")}list.remove(this.insertionPoint);this.insertionPoint=tmp}this.insertionPoint=null;return this.addItem(item,list,capacity)},removeItem:function(item,list){if(!item.getInsertionBounds().intersects(this.extents))return false;if(this.subNode!=null){var result=false;for(var i=0;i<4;i++)result|=this.subNode[i].removeItem(item,list);if(result){this.isDirty=true;this.numItems--}return result}var i=this.insertionPoint;var n=this.numItems;for(;i&&n--;i=i.next){if(i.value==item)break}if(i==null)return false;this.isDirty=true;this.numItems--;item.numRefNodes--;if(i===this.insertionPoint)this.insertionPoint=this.numItems?i.next:null;list.remove(i);item.notifyRemoved();return true},selectItems:function(rect){if(!rect.intersects(this.extents))return;if(this.subNode!=null){for(var i=0;i<4;i++)this.subNode[i].selectItems(rect)}else{var i=this.insertionPoint;var n=this.numItems;for(;i&&n--;i=i.next){if(i.value.visible==true&&i.value.getInsertionBounds().intersects(rect)||i.value.flags&QuadTreeItem.FLAG_ALWAYS_SELECT)i.value.flags|=QuadTreeItem.FLAG_SELECTED}}},detectCollisions:function(handler,context){if(!this.isDirty)return;this.isDirty=false;if(this.subNode!=null){for(var i=0;i<4;i++)this.subNode[i].detectCollisions(handler,context);return}var n=this.numItems;var i_next;for(var i=this.insertionPoint;i&&n>1;i=i_next){var i_next=i.next;var m=--n;if(i.value.visible==false)continue;if(!handler.onFilterRequest(i.value,context))continue;var rect=i.value.getLBounds();var j_next;for(var j=i.next;j&&m-- >0;j=j_next){var j_next=j.next;if(j.value.visible==false)continue;if(!handler.onFilterRequest(j.value,context))continue;if(!j.value.getLBounds().intersects(rect))continue;var iId=i.objectId;var jId=j.objectId;handler.onCollision(i.value,j.value,context);if(i.objectId!=iId){i_next=this.insertionPoint;n=this.numItems;break}if(j.objectId!=jId){j_next=i.next;m=n;continue}}}}})},{"./globals":11,"./quadtree-item":38,"./rect":41,"@rsthn/rin/class":35}],40:[function(require,module,exports){require("./globals");const Class=require("@rsthn/rin/class");const List=require("./list");const QuadTreeNode=require("./quadtree-node");const QuadTreeItem=require("./quadtree-item");const QuadTree=module.exports=Class.extend({className:"QuadTree",root:null,items:null,orderedItems:null,updateQueue:null,nodeCapacity:0,nextItem:null,isReverse:false,visible:true,xd:false,yd:false,zd:false,__ctor:function(x1,y1,x2,y2,nodeCapacity){this.items=new List;this.orderedItems=new List;this.updateQueue=new List;this.root=new QuadTreeNode(x1,y1,x2,y2);this.nodeCapacity=nodeCapacity;this.isReverse=false;this.visible=true;this.fnComparator=this.COMPARATOR_DEFAULT_YX},__dtor:function(){this.root.destroy(this.items);dispose(this.items);dispose(this.orderedItems);dispose(this.updateQueue)},getExtents:function(){return this.root.getExtents()},setVisible:function(value){this.visible=value;return this},getVisible:function(){return this.visible},setXd:function(value){if(this.xd==value)return false;this.xd=value;return true},setYd:function(value){if(this.yd==value)return false;this.yd=value;return true},setZd:function(value){if(this.zd==value)return false;this.zd=value;return true},getXd:function(){return this.xd},getYd:function(){return this.yd},getZd:function(){return this.zd},fnComparator:null,setComparator:function(fnComparator){if(this.fnComparator==fnComparator)return false;this.fnComparator=fnComparator;return true},COMPARATOR_DEFAULT_YX:function(a,b,p,q){return p.zindex<q.zindex^this.zd||p.zindex==q.zindex&&(a.y1<b.y1^this.yd||a.y1==b.y1&&a.x1<b.x1^this.xd)},COMPARATOR_DEFAULT_XY:function(a,b,p,q){return p.zindex<q.zindex^this.zd||p.zindex==q.zindex&&(a.x1<b.x1^this.xd||a.x1==b.x1&&a.y1<b.y1^this.yd)},COMPARATOR_MANHATTAN:function(a,b,p,q){return p.zindex<q.zindex^this.zd||p.zindex==q.zindex&&a.cx+a.cy<b.cx+b.cy},COMPARATOR_Y2:function(a,b,p,q){return p.zindex<q.zindex^this.zd||p.zindex==q.zindex&&(a.y2<b.y2^this.yd||a.y2==b.y2&&a.x1<=b.x1^this.xd)},COMPARATOR_Y1:function(a,b,p,q){return a.y1+p.zindex<b.y1+q.zindex^this.yd},COMPARATOR_X2:function(a,b,p,q){return a.x2+p.zindex<b.x2+q.zindex^this.xd},COMPARATOR_X1:function(a,b,p,q){return a.x1+p.zindex<b.x1+q.zindex^this.xd},isBefore:function(p,q){return this.fnComparator(p.getLBounds(),q.getLBounds(),p,q)},addItemOrdered:function(item){for(var i=this.orderedItems.top;i;i=i.next){if(this.isBefore(item,i.value)){this.orderedItems.insertBefore(i,item);return}}this.orderedItems.push(item)},reorderItems:function(){var tmp=this.orderedItems;this.orderedItems=new List;for(var i=tmp.top;i;i=i.next){this.addItemOrdered(i.value)}dispose(tmp)},addItem:function(item){if(this.root.addItem(item,this.items,this.nodeCapacity)){this.addItemOrdered(item);return true}return false},removeItem:function(item){if(!(item.flags&QuadTreeItem.FLAG_ATTACHED))return true;if(!this.root.removeItem(item,this.items))return false;this.orderedItems.remove(this.orderedItems.sgetNode(item));return true},updateItem:function(item){this.removeItem(item);if(!this.addItem(item)){dispose(item,"QuadTree::updateItem");return}if(item.flags&QuadTreeItem.FLAG_QUEUED)return;this.updateQueue.push(item);item.flags|=QuadTreeItem.FLAG_QUEUED},update:function(){var i;while(i=this.updateQueue.pop()){i.flags&=~QuadTreeItem.FLAG_QUEUED;i.notifyPosition()}},getItems:function(){return this.orderedItems},setReverse:function(value){this.isReverse=value;return this},selectItems:function(rect,isReverse=null){if(isReverse===null)isReverse=this.isReverse;this.root.selectItems(rect);this.nextItem=isReverse?this.orderedItems.bottom:this.orderedItems.top},getNextSelectedItem:function(isReverse=null){if(isReverse===null)isReverse=this.isReverse;while(this.nextItem!=null&&!(this.nextItem.value.flags&QuadTreeItem.FLAG_SELECTED)){this.nextItem=isReverse?this.nextItem.prev:this.nextItem.next}var ret=this.nextItem;if(this.nextItem){this.nextItem.value.flags&=~QuadTreeItem.FLAG_SELECTED;this.nextItem=isReverse?this.nextItem.prev:this.nextItem.next}return ret?ret.value:null},detectCollisions:function(handler,context){var attempts=16;while(this.root.isDirty&&--attempts!=0)this.root.detectCollisions(handler,context);if(attempts==0)console.log("Error: Collision detection generated an unresolved state.")}})},{"./globals":11,"./list":30,"./quadtree-item":38,"./quadtree-node":39,"@rsthn/rin/class":35}],41:[function(require,module,exports){const Recycler=require("./recycler");const Rect=module.exports=function(){};Rect.prototype.className="Rect";Rect.prototype.cx=0;Rect.prototype.cy=0;Rect.prototype.x1=0;Rect.prototype.y1=0;Rect.prototype.x2=0;Rect.prototype.y2=0;Rect.prototype.__reinit=function(){switch(arguments.length){case 0:this.Rect0.apply(this,arguments);break;case 2:this.Rect2.apply(this,arguments);break;case 4:this.Rect4.apply(this,arguments);break}return this};Rect.prototype.Rect0=function(){this.x1=this.y1=this.x2=this.y2=this.cx=this.cy=0};Rect.prototype.Rect4=function(x1,y1,x2,y2){this.set(x1,y1,x2,y2)};Rect.prototype.Rect2=function(w,h){this.set(0,0,0,0);this.resize(w,h)};Rect.prototype.clone=function(){return Rect.alloc(this.x1,this.y1,this.x2,this.y2)};Rect.prototype.zero=function(){this.cx=0;this.cy=0;this.x1=0;this.y1=0;this.x2=0;this.y2=0;return this};Rect.prototype.reset=function(){this.cx=null;this.cy=null;this.x1=null;this.y1=null;this.x2=null;this.y2=null;return this};Rect.prototype.extendWithPoint2=function(x,y){if(this.x1===null||x<this.x1)this.x1=x;if(this.y1===null||y<this.y1)this.y1=y;if(this.x2===null||x>this.x2)this.x2=x;if(this.y2===null||y>this.y2)this.y2=y;this.cx=(this.x1+this.x2)/2;this.cy=(this.y1+this.y2)/2;return this};Rect.prototype.extendWithPoint1=function(p){return this.extendWithPoint2(p.x,p.y)};Rect.prototype.translate=function(dx,dy){this.x1+=dx;this.y1+=dy;this.x2+=dx;this.y2+=dy;this.cx+=dx;this.cy+=dy;return this};Rect.prototype.centerAt=function(x,y,relative){if(relative===true){x=this.x1+x*(this.x2-this.x1);y=this.y1+y*(this.y2-this.y1)}return this.translate(x-this.cx,y-this.cy)};Rect.prototype.set=function(){switch(arguments.length){case 1:return this.set1.apply(this,arguments);case 4:return this.set4.apply(this,arguments)}};Rect.prototype.set4=function(x1,y1,x2,y2){this.cx=(x1+x2)/2;this.cy=(y1+y2)/2;this.x1=x1;this.y1=y1;this.x2=x2;this.y2=y2;return this};Rect.prototype.set1=function(r){return this.set4(r.x1,r.y1,r.x2,r.y2)};Rect.prototype.equals=function(){switch(arguments.length){case 1:return this.equals1.apply(this,arguments);case 4:return this.equals4.apply(this,arguments)}};Rect.prototype.equals1=function(r){return this.x1==r.x1&&this.x2==r.x2&&this.y1==r.y1&&this.y2==r.y2};Rect.prototype.equals4=function(x1,y1,x2,y2){return x1==this.x1&&x2==this.x2&&y1==this.y1&&y2==this.y2};Rect.prototype.contains=function(){switch(arguments.length){case 1:return this.contains1.apply(this,arguments);case 4:return this.contains4.apply(this,arguments)}};Rect.prototype.contains1=function(b){return b.equals(Math.max(this.x1,b.x1),Math.max(this.y1,b.y1),Math.min(this.x2,b.x2),Math.min(this.y2,b.y2))};Rect.prototype.contains4=function(x1,y1,x2,y2){return x1==Math.max(this.x1,x1)&&y1==Math.max(this.y1,y1)&&x2==Math.min(this.x2,x2)&&y2==Math.min(this.y2,y2)};Rect.prototype.setAsUnion=function(){switch(arguments.length){case 1:return this.setAsUnion1.apply(this,arguments);case 4:return this.setAsUnion4.apply(this,arguments)}};Rect.prototype.setAsUnion1=function(b){return this.setAsUnion4(b.x1,b.y1,b.x2,b.y2)};Rect.prototype.setAsUnion4=function(x1,y1,x2,y2){this.x1=Math.min(this.x1,x1);this.y1=Math.min(this.y1,y1);this.x2=Math.max(this.x2,x2);this.y2=Math.max(this.y2,y2);return this};Rect.prototype.intersects=function(){switch(arguments.length){case 1:return this.intersects1.apply(this,arguments);case 4:return this.intersects4.apply(this,arguments)}};Rect.prototype.intersects1=function(b){return this.intersects4(b.x1,b.y1,b.x2,b.y2)};Rect.prototype.intersects4=function(x1,y1,x2,y2){var _x1=Math.max(this.x1,x1);var _y1=Math.max(this.y1,y1);var _x2=Math.min(this.x2,x2);var _y2=Math.min(this.y2,y2);return Math.max(0,_y2-_y1)*Math.max(0,_x2-_x1)>0};Rect.prototype.setAsIntersection=function(){switch(arguments.length){case 1:return this.setAsIntersection1.apply(this,arguments);case 4:return this.setAsIntersection4.apply(this,arguments)}};Rect.prototype.setAsIntersection1=function(b){return this.setAsIntersection4(b.x1,b.y1,b.x2,b.y2)};Rect.prototype.setAsIntersection4=function(x1,y1,x2,y2){this.x1=Math.max(this.x1,x1);this.y1=Math.max(this.y1,y1);this.x2=Math.min(this.x2,x2);this.y2=Math.min(this.y2,y2);return Math.max(0,this.y2-this.y1)*Math.max(0,this.x2-this.x1)>0};Rect.prototype.resize=function(w,h,relative){if(relative===true){w*=this.x2-this.x1;h*=this.y2-this.y1}w/=2;h/=2;this.x1=this.cx-w;this.y1=this.cy-h;this.x2=this.cx+w;this.y2=this.cy+h;return this};Rect.prototype.resizeBy=function(dw,dh){dw/=2;dh/=2;this.x1-=dw;this.y1-=dh;this.x2+=dw;this.y2+=dh;return this};Rect.prototype.width=function(){return this.x2-this.x1};Rect.prototype.height=function(){return this.y2-this.y1};Rect.prototype.ncx=function(){return(this.cx-this.x1)/(this.x2-this.x1)};Rect.prototype.ncy=function(){return(this.cy-this.y1)/(this.y2-this.y1)};Rect.prototype.isRight=function(){return this.x1<=this.x2&&this.y1<=this.y2};Rect.prototype.containsPoint=function(x,y,tol){if(!tol)tol=0;return this.x1-tol<=x&&x<=this.x2+tol&&(this.y1-tol<=y&&y<=this.y2+tol)};Rect.prototype.area=function(strict){return strict?this.isRight()?(this.y2-this.y1)*(this.x2-this.x1):0:(this.y2-this.y1)*(this.x2-this.x1)};Rect.prototype.floor=function(){this.x1=Math.floor(this.x1);this.y1=Math.floor(this.y1);this.x2=Math.floor(this.x2);this.y2=Math.floor(this.y2);this.cx=Math.floor(this.cx);this.cy=Math.floor(this.cy);return this};Rect.prototype.ceil=function(){this.x1=Math.ceil(this.x1);this.y1=Math.ceil(this.y1);this.x2=Math.ceil(this.x2);this.y2=Math.ceil(this.y2);this.cx=Math.ceil(this.cx);this.cy=Math.ceil(this.cy);return this};Rect.prototype.toString=function(){return"(Rect: "+this.x1.toFixed(2)+", "+this.y1.toFixed(2)+", "+this.x2.toFixed(2)+", "+this.y2.toFixed(2)+")"};Rect.prototype.flatten=function(){return[this.x1,this.y1,this.x2,this.y2]};Rect.prototype.unflatten=function(o){this.set(o[0],o[1],o[2],o[3]);return this};Recycler.attachTo(Rect)},{"./recycler":42}],42:[function(require,module,exports){const recyclingFacilities={};module.exports.attachTo=function(_class,_maxPoolSize){if(!_maxPoolSize)_maxPoolSize=1024;if(!_class.prototype.className)throw new Error("Unable to attach recycler functions to unnamed class.");recyclingFacilities[_class.prototype.className]=_class;_class.recyclerPool=[];_class.prototype.objectId=0;_class.nextObjectId=0;_class.createdItems=0;_class.restoredItems=0;_class.recycledItems=0;_class.alloc=function(){var item;if(!this.recyclerPool.length){item=new _class;_class.createdItems++}else{item=this.recyclerPool.pop();_class.restoredItems++}if("__reinit"in item)item.__reinit.apply(item,arguments);item.objectId=++this.nextObjectId;this.nextObjectId=this.nextObjectId&1073741823;return item};_class.prototype.dispose=function(reason){if(this.objectId==0){console.error("Already disposed ("+_class.prototype.className+"): "+reason+" / "+this.disposeReason);return}if("__dtor"in this)this.__dtor();_class.recycledItems++;this.objectId=0;this.disposeReason=reason;if(_class.recyclerPool.length<_maxPoolSize)_class.recyclerPool.push(this)}};module.exports.showStats=function(){console.group("Recycling Facilities");for(var i in recyclingFacilities){var c=recyclingFacilities[i];console.debug(i+": created="+c.createdItems+", restored="+c.restoredItems+", recycled="+c.recycledItems+", available="+c.recyclerPool.length)}console.groupEnd()}},{}],43:[function(require,module,exports){(function(global){require("./globals");const Rin=require("@rsthn/rin/alpha");const System=require("./system");const Canvas=require("./canvas");const Wrappers=require("./wrappers");const Resources=module.exports={integerScaling:true,load:function(list,callback,completeCallback,keyList,index){if(!keyList){keyList=Object.keys(list);list.__original=Rin.clone(list);index=0}if(callback)callback(index,keyList.length,index/keyList.length);if(index==keyList.length){if(completeCallback)completeCallback(list);return}var r=list[keyList[index]];r.resName=keyList[index];switch(r.type){case"image":r.data=new Image;r.data.onload=function(){var ratio=r.data.width/r.data.height;if(r.scale){r.width=~~(r.data.width*r.scale);r.height=~~(r.data.height*r.scale)}if(!r.width&&!r.height){r.width=r.data.width;r.height=r.data.height}else if(r.width&&!r.height){r.height=int(r.width/ratio)}else if(!r.width&&r.height){r.width=int(ratio*r.height)}r.owidth=r.data.width;r.oheight=r.data.height;if(r.data.width!=r.width||r.data.height!=r.height||r.original!==true&&System.scaleFactor!=1){if(r.original===true)r.data=Resources.resizeImage(r,r.width,r.height,r.pixelated,true);else r.data=Resources.resizeImage(r,r.width*(r.pixelated?System.integerScaleFactor:System.scaleFactor),r.height*(r.pixelated?System.integerScaleFactor:System.scaleFactor),r.pixelated,true)}r.rscale=r.data.width/r.width;System.tempDisplayBuffer.drawImage(r.data,0,0);Resources.onLoaded(list,keyList[index]);Resources.load(list,callback,completeCallback,keyList,index+1)};r.data.onerror=function(){console.error("Error: Unable to load: "+r.resName)};r.data.src=r.src+"?r="+Math.random();break;case"images":var src=r.src;var d0=src.indexOf("#");var d1=src.lastIndexOf("#");var dN=d1-d0+1;if(d0==-1){console.error("Unable to load: "+r.resName+"\nError: The 'src' attribute requires one or more '#' marks.");return}if(!r.count){console.error("Unable to load: "+r.resName+"\nError: The 'count' attribute was not found.");return}r._i=0;r.data=[];var cb=function(){if(r._i==r.count){Resources.onLoaded(list,keyList[index]);Resources.load(list,callback,completeCallback,keyList,index+1);return}var tmp={type:"image",width:r.width,height:r.height,scale:r.scale};tmp.src=r.src.substr(0,d0)+(r._i++/Math.pow(10,dN)).toFixed(dN).substr(2)+r.src.substr(d1+1);tmp.data=new Image;tmp.resName=r.resName+"#"+(r._i-1);tmp.data.onload=function(){var ratio=tmp.data.width/tmp.data.height;if(tmp.scale){tmp.width=~~(tmp.data.width*tmp.scale);tmp.height=~~(tmp.data.height*tmp.scale)}if(!tmp.width&&!tmp.height){tmp.width=tmp.data.width;tmp.height=tmp.data.height}else if(tmp.width&&!tmp.height){tmp.height=int(tmp.width/ratio)}else if(!tmp.width&&tmp.height){tmp.width=int(ratio*tmp.height)}if(r._i==1){r.owidth=tmp.data.width;r.oheight=tmp.data.height}if(tmp.data.width!=tmp.width||tmp.data.height!=tmp.height||tmp.original!==true&&System.scaleFactor!=1){if(tmp.original===true)tmp.data=Resources.resizeImage(tmp,tmp.width,tmp.height,r.pixelated,true);else tmp.data=Resources.resizeImage(tmp,tmp.width*(r.pixelated?System.integerScaleFactor:System.scaleFactor),tmp.height*(r.pixelated?System.integerScaleFactor:System.scaleFactor),r.pixelated,true)}tmp.rscale=tmp.data.width/tmp.width;if(r._i==1){r.width=tmp.width;r.height=tmp.height;r.rscale=tmp.rscale}System.tempDisplayBuffer.drawImage(tmp.data,0,0);r.data.push(tmp);cb()};tmp.data.onerror=function(){console.error("Error: Unable to load: "+tmp.resName)};tmp.data.src=tmp.src+"?r="+Math.random()};cb();break;case"audio":if(!r.track)r.track="sfx";if(global.plugins&&global.plugins.NativeAudio&&r.track=="sfx"){r.engine=Wrappers.Sound.ENGINE_NATIVEAUDIO;r.data="snd_"+index;global.plugins.NativeAudio.preloadSimple(r.data,r.src,function(){Resources.onLoaded(list,keyList[index]);Resources.load(list,callback,completeCallback,keyList,index+1)},function(e){console.error("Error: Unable to load (sfx): "+r.resName+"\n"+e)});break}if(global.audioContext){r.engine=Wrappers.Sound.ENGINE_WEBAUDIO;fetchAudioBuffer(r.src+"?r="+Math.random()).then(audioBuffer=>{r.data=audioBuffer;Resources.onLoaded(list,keyList[index]);Resources.load(list,callback,completeCallback,keyList,index+1)}).catch(err=>{console.error("Error: Unable to load: "+r.resName)});break}r.data=new Audio;r.engine=Wrappers.Sound.ENGINE_HTML5;r.data.oncanplaythrough=function(){Resources.onLoaded(list,keyList[index]);Resources.load(list,callback,completeCallback,keyList,index+1)};r.data.onerror=function(){console.error("Error: Unable to load: "+r.resName)};r.data.src=r.src+"?r="+Math.random();break;case"audios":var src=r.src;var d0=src.indexOf("#");var d1=src.lastIndexOf("#");var dN=d1-d0+1;if(d0==-1){console.error("Unable to load: "+r.resName+"\nError: The 'src' attribute requires one or more '#' marks.");return}if(!r.count){console.error("Unable to load: "+r.resName+"\nError: The 'count' attribute was not found.");return}r._i=0;r.data=[];var cb=function(){if(r._i==r.count){Resources.onLoaded(list,keyList[index]);Resources.load(list,callback,completeCallback,keyList,index+1);return}var tmp={type:"audio",track:r.track};tmp.src=r.src.substr(0,d0)+(r._i++/Math.pow(10,dN)).toFixed(dN).substr(2)+r.src.substr(d1+1);tmp.resName=r.resName+"#"+(r._i-1);if(!tmp.track)tmp.track="sfx";if(global.plugins&&global.plugins.NativeAudio&&tmp.track=="sfx"){tmp.engine=Wrappers.Sound.ENGINE_NATIVEAUDIO;tmp.data="snd_"+index+"_"+r._i;global.plugins.NativeAudio.preloadSimple(tmp.data,tmp.src,function(){r.data.push(tmp);cb()},function(e){console.error("Error: Unable to load (sfx): "+tmp.resName+"\n"+e)});return}if(global.audioContext){tmp.engine=Wrappers.Sound.ENGINE_WEBAUDIO;fetchAudioBuffer(tmp.src+"?r="+Math.random()).then(audioBuffer=>{tmp.data=audioBuffer;r.data.push(tmp);cb()}).catch(err=>{console.error("Error: Unable to load: "+tmp.resName)});return}tmp.data=new Audio;tmp.engine=Wrappers.Sound.ENGINE_HTML5;tmp.data.oncanplaythrough=function(){r.data.push(tmp);cb()};tmp.data.onerror=function(){console.error("Error: Unable to load: "+tmp.resName)};tmp.data.src=tmp.src+"?r="+Math.random()};cb();break;case"json":fetchd(r.src+"?r="+Math.random(),{responseType:"json"}).then(function(json){r.data=json;Resources.onLoaded(list,keyList[index]);Resources.load(list,callback,completeCallback,keyList,index+1)}).catch(function(err){console.error("Error: Unable to load: "+r.resName+". Error: "+err)});break;case"object":r.data={};Resources.onLoaded(list,keyList[index]);Resources.load(list,callback,completeCallback,keyList,index+1);break}},unload:function(list){var __original;for(var i in list){if(i=="__original"){__original=list[i];delete list[i];continue}if(list[i].r){dispose(list[i]);list[i]=list[i].r}switch(list[i].type){case"audio":break;case"audios":break;case"images":for(var j=0;j<list[i].data.length;j++)dispose(list[i].data[j]);break;default:dispose(list[i].data);break}list[i].data=null;delete list[i]}for(var i in __original)list[i]=__original[i]},onLoaded:function(list,index){var r=list[index];if(!r.wrapper||!(r.wrapper in Wrappers))return;list[index]=new Wrappers[r.wrapper](r)},resizeImage:function(image,dw,dh,pixelated,discardOriginal){var sw=image.data.width;var sh=image.data.height;dw=int(dw);dh=int(dh);if(sw==dw&&sh==dh)return image.data;if(!this.integerScaling&&pixelated)pixelated=null;if(!pixelated){pixelated=pixelated===null?false:true;var temp=new Canvas(null,{hidden:true,antialias:pixelated}).resize(sw,sh);temp.drawImage(image.data,0,0);while(true){var tw=sw>>1;var th=sh>>1;if(tw<=dw||th<=dh)break;var output=new Canvas(null,{hidden:true,antialias:pixelated}).resize(tw,th);output.drawImage(temp.elem,0,0,tw,th);temp.dispose();sw=tw;sh=th;temp=output}var output=new Canvas(null,{hidden:true,antialias:pixelated}).resize(dw,dh);output.drawImage(temp.elem,0,0,dw,dh);temp.dispose();if(discardOriginal)dispose(image.data);return output.elem}else{if(~~(dw/sw)>0){var ratio=~~(dw/sw+.9);dw=ratio*sw;dh=ratio*sh;var rep_x=dw/sw;var rep_y=dh/sh;var output=new Canvas(null,{hidden:true,antialias:false}).resize(dw,dh);var temp=new Canvas(null,{hidden:true,antialias:false}).resize(sw,sh);temp.drawImage(image.data,0,0);for(var j=0;j<sh;j++){var s=temp.getImageData(0,j,sw,1).data;var sp=0;for(var i=0;i<sw&&sp<s.length;i++,sp+=4){output.fillStyle("rgba("+s[sp]+","+s[sp+1]+","+s[sp+2]+","+s[sp+3]/255+")");output.fillRect(i*rep_x,j*rep_y,rep_x,rep_y)}}temp.dispose();return output.elem}return this.resizeImage(image,dw,dh,null,discardOriginal)}},flipImageHorz:function(image){var temp=new Canvas(null,{hidden:true}).resize(image.data.width,image.data.height);temp.translate(image.data.width,0);temp.scale(-1,1);temp.drawImage(image.data,0,0);return temp.elem},showDownload:function(filename,dataUrl){var link=document.createElement("a");link.href=dataUrl;link.style.display="none";link.download=filename;link.target="_blank";document.body.appendChild(link);link.click();document.body.removeChild(link)},showFilePicker:function(allowMultiple,callback){var input=document.createElement("input");input.type="file";input.style.display="none";input.multiple=allowMultiple;document.body.appendChild(input);input.onchange=function(){if(input._timer)clearTimeout(input._timer);document.body.onfocus=null;document.body.removeChild(input);callback(input.files)};document.body.onfocus=function(){document.body.onfocus=null;input._timer=setTimeout(function(){document.body.removeChild(input);callback(null)},0)};input.click()},loadAsDataURL:function(file,callback){var reader=new FileReader;reader.onload=function(e){callback(e.target.result)};reader.readAsDataURL(file)},loadAsText:function(file,callback){var reader=new FileReader;reader.onload=function(e){callback(e.target.result)};reader.readAsText(file)},loadAsArrayBuffer:function(file,callback){var reader=new FileReader;reader.onload=function(e){callback(e.target.result)};reader.readAsArrayBuffer(file)},loadAllAsDataURL:function(fileList,callback){var result=[];if(!fileList||!fileList.length){callback(result);return}var loadNext=function(i){if(i==fileList.length){callback(result);return}Resources.loadAsDataURL(fileList[i],function(url){result.push({name:fileList[i].name,size:fileList[i].size,url:url});loadNext(i+1)})};loadNext(0)}}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./canvas":3,"./globals":11,"./system":44,"./wrappers":49,"@rsthn/rin/alpha":34}],44:[function(require,module,exports){(function(global){require("./globals");const KeyCodes=require("./keycodes");const List=require("./list");const Linkable=require("./linkable");const Timer=require("./timer");const Canvas=require("./canvas");const System=module.exports={flags:{renderingEnabled:false,renderingPaused:false},EVT_KEY_DOWN:1,EVT_KEY_UP:2,EVT_POINTER_DOWN:16,EVT_POINTER_UP:17,EVT_POINTER_MOVE:18,EVT_POINTER_DRAG_START:19,EVT_POINTER_DRAG_MOVE:20,EVT_POINTER_DRAG_STOP:21,DEFAULT:0,LANDSCAPE:1,PORTRAIT:2,AUTOMATIC:3,defaultOptions:{background:"#000",fps:60,minFps:15,context:null,antialias:true,targetScreenWidth:null,targetScreenHeight:null,orientation:0,extraScaleFactor:1,fullscreen:true},screenWidth:0,screenHeight:0,offsX:0,offsY:0,devicePixelRatio:1,backingStoreRatio:1,canvasPixelRatio:1,canvasScaleFactor:1,scaleFactor:1,initialMatrix:null,displayBuffer:null,tempDisplayBuffer:null,context:null,keyState:{},keyEvtArgs:{shift:false,ctrl:false,alt:false,keyCode:0,keyState:null},pointerState:{},updateQueue:null,drawQueue:null,timeScale:1,frameInterval:0,fixedFrameInterval:0,maxFrameInterval:0,frameDelta:0,frameDeltaMillis:0,frameTime:0,frameNumber:0,frameUpdateInProgress:false,frameDrawInProgress:false,perf:{startTime:0,lastTime:0,numFrames:0,updateTime:0,drawTime:0},init:function(opts){var o={};Object.assign(o,this.defaultOptions);if(opts)Object.assign(o,opts);this.options=o;if(o.targetScreenWidth&&o.targetScreenHeight&&o.orientation==System.DEFAULT){o.orientation=o.targetScreenWidth>o.targetScreenHeight?System.LANDSCAPE:System.PORTRAIT}this.context=o.context;this.orientation=o.orientation;this.updateQueue=new List;this.drawQueue=new List;this.frameInterval=int(1e3/o.fps);this.maxFrameInterval=int(1e3/o.minFps);global.onresize=this.onWindowResized.bind(this);this.frameTimer=new Timer(this.frameInterval,this.onFrame,this);this.displayBuffer=new Canvas(null,{hidden:false,antialias:o.antialias,background:o.background});this.tempDisplayBuffer=new Canvas(null,{hidden:true,antialias:o.antialias}).resize(320,240);var display0=this.displayBuffer.elem;this.devicePixelRatio=global.devicePixelRatio||1;this.backingStoreRatio=this.displayBuffer.context.webkitBackingStorePixelRatio||this.displayBuffer.context.mozBackingStorePixelRatio||this.displayBuffer.context.msBackingStorePixelRatio||this.displayBuffer.context.oBackingStorePixelRatio||this.displayBuffer.context.backingStorePixelRatio||1;this.canvasPixelRatio=this.devicePixelRatio/this.backingStoreRatio;System.onWindowResized(true);this.keyState={};this.keyEvtArgs={shift:false,ctrl:false,alt:false,keyCode:0,keyState:this.keyState};var _this=this;global.onkeydown=function(evt){if(evt.target!==global.document.body)return;if(_this.keyState[evt.keyCode])return false;_this.keyState[evt.keyCode]=true;_this.keyEvtArgs.keyCode=evt.keyCode;switch(evt.keyCode){case 16:_this.keyEvtArgs.shift=true;break;case 17:_this.keyEvtArgs.ctrl=true;break;case 18:_this.keyEvtArgs.alt=true;break}if(_this.keyEvtArgs.ctrl&&evt.keyCode==KeyCodes.TAB){_this.keyState[evt.keyCode]=false;return true}if(_this.onKeyboardEvent(_this.EVT_KEY_DOWN,evt.keyCode,_this.keyEvtArgs)===false)return false};global.onkeyup=function(evt){if(evt.target!==global.document.body)return;if(!_this.keyState[evt.keyCode])return false;_this.keyState[evt.keyCode]=false;_this.keyEvtArgs.keyCode=evt.keyCode;switch(evt.keyCode){case 16:_this.keyEvtArgs.shift=false;break;case 17:_this.keyEvtArgs.ctrl=false;break;case 18:_this.keyEvtArgs.alt=false;break}if(_this.onKeyboardEvent(_this.EVT_KEY_UP,evt.keyCode,_this.keyEvtArgs)===false)return false};if("ontouchstart"in global){display0.ontouchstart=function(evt){evt.preventDefault();var touches=evt.changedTouches;for(var i=0;i<touches.length;i++){if(!System.pointerState[touches[i].identifier]){System.pointerState[touches[i].identifier]={id:touches[i].identifier,isActive:false,isDragging:false,sx:0,sy:0,x:0,y:0,dx:0,dy:0,button:0}}var p=System.pointerState[touches[i].identifier];p.isActive=true;p.isDragging=false;p.button=1;p.startTime=System.now(true);p.x=p.sx=System.reverseRender?~~((touches[i].clientY-System.offsY)/System.canvasScaleFactor):~~((touches[i].clientX-System.offsX)/System.canvasScaleFactor);p.y=p.sy=System.reverseRender?~~(System.screenHeight-(touches[i].clientX-System.offsX)/System.canvasScaleFactor-1):~~((touches[i].clientY-System.offsY)/System.canvasScaleFactor);System.onPointerEvent(System.EVT_POINTER_DOWN,p,System.pointerState)}return false};display0.ontouchend=function(evt){evt.preventDefault();var touches=evt.changedTouches;for(var i=0;i<touches.length;i++){if(!System.pointerState[touches[i].identifier])continue;var p=System.pointerState[touches[i].identifier];p.endTime=System.now(true);p.deltaTime=p.endTime-p.startTime;p.x=System.reverseRender?~~((touches[i].clientY-System.offsY)/System.canvasScaleFactor):~~((touches[i].clientX-System.offsX)/System.canvasScaleFactor);p.y=System.reverseRender?~~(System.screenHeight-(touches[i].clientX-System.offsX)/System.canvasScaleFactor-1):~~((touches[i].clientY-System.offsY)/System.canvasScaleFactor);if(p.isDragging)System.onPointerEvent(System.EVT_POINTER_DRAG_STOP,p,System.pointerState);System.onPointerEvent(System.EVT_POINTER_UP,p,System.pointerState);p.isActive=false;p.isDragging=false;p.button=0}return false};display0.ontouchcancel=function(evt){evt.preventDefault();var touches=evt.changedTouches;for(var i=0;i<touches.length;i++){if(!System.pointerState[touches[i].identifier])continue;var p=System.pointerState[touches[i].identifier];p.x=System.reverseRender?~~((touches[i].clientY-System.offsY)/System.canvasScaleFactor):~~((touches[i].clientX-System.offsX)/System.canvasScaleFactor);p.y=System.reverseRender?~~(System.screenHeight-(touches[i].clientX-System.offsX)/System.canvasScaleFactor-1):~~((touches[i].clientY-System.offsY)/System.canvasScaleFactor);System.onPointerEvent(p.isDragging?System.EVT_POINTER_DRAG_STOP:System.EVT_POINTER_UP,p,System.pointerState);p.isActive=false;p.isDragging=false;p.button=0}return false};display0.ontouchmove=function(evt){evt.preventDefault();var touches=evt.changedTouches;for(var i=0;i<touches.length;i++){if(!System.pointerState[touches[i].identifier])continue;var p=System.pointerState[touches[i].identifier];if(p.isActive&&!p.isDragging){System.onPointerEvent(System.EVT_POINTER_DRAG_START,p,System.pointerState);p.isDragging=true}p.x=System.reverseRender?~~((touches[i].clientY-System.offsY)/System.canvasScaleFactor):~~((touches[i].clientX-System.offsX)/System.canvasScaleFactor);p.y=System.reverseRender?~~(System.screenHeight-(touches[i].clientX-System.offsX)/System.canvasScaleFactor-1):~~((touches[i].clientY-System.offsY)/System.canvasScaleFactor);p.dx=p.x-p.sx;p.dy=p.y-p.sy;System.onPointerEvent(p.isDragging?System.EVT_POINTER_DRAG_MOVE:System.EVT_POINTER_MOVE,p,System.pointerState)}return false}}else{display0.onmousedown=function(evt){evt.preventDefault();if(!System.pointerState[0]){System.pointerState[0]={id:0,isActive:false,isDragging:false,button:0,sx:0,sy:0,x:0,y:0,dx:0,dy:0}}var p=System.pointerState[0];p.isActive=true;p.isDragging=false;p.button=evt.which;p.x=p.sx=System.reverseRender?~~((evt.clientY-System.offsY)/System.canvasScaleFactor):~~((evt.clientX-System.offsX)/System.canvasScaleFactor);p.y=p.sy=System.reverseRender?~~(System.screenHeight-(evt.clientX-System.offsX)/System.canvasScaleFactor-1):~~((evt.clientY-System.offsY)/System.canvasScaleFactor);System.onPointerEvent(System.EVT_POINTER_DOWN,p,System.pointerState);return false};display0.onmouseup=function(evt){evt.preventDefault();if(!System.pointerState[0])return false;var p=System.pointerState[0];p.x=System.reverseRender?~~((evt.clientY-System.offsY)/System.canvasScaleFactor):~~((evt.clientX-System.offsX)/System.canvasScaleFactor);p.y=System.reverseRender?~~(System.screenHeight-(evt.clientX-System.offsX)/System.canvasScaleFactor-1):~~((evt.clientY-System.offsY)/System.canvasScaleFactor);if(p.isDragging)System.onPointerEvent(System.EVT_POINTER_DRAG_STOP,p,System.pointerState);System.onPointerEvent(System.EVT_POINTER_UP,p,System.pointerState);p.isActive=false;p.isDragging=false;p.button=0};display0.onmousemove=function(evt){evt.preventDefault();if(!System.pointerState[0])return false;var p=System.pointerState[0];if(p.isActive&&!p.isDragging){System.onPointerEvent(System.EVT_POINTER_DRAG_START,p,System.pointerState);p.isDragging=true}p.x=System.reverseRender?~~((evt.clientY-System.offsY)/System.canvasScaleFactor):~~((evt.clientX-System.offsX)/System.canvasScaleFactor);p.y=System.reverseRender?~~(System.screenHeight-(evt.clientX-System.offsX)/System.canvasScaleFactor-1):~~((evt.clientY-System.offsY)/System.canvasScaleFactor);p.dx=p.x-p.sx;p.dy=p.y-p.sy;System.onPointerEvent(p.isDragging?System.EVT_POINTER_DRAG_MOVE:System.EVT_POINTER_MOVE,p,System.pointerState);return false}}},now:function(notmillis){var value=hrnow();return notmillis?value/1e3:value},time:function(){return this.frameTime},start:function(){this.onWindowResized();this.flags.renderingPaused=false;this.frameTimer.start()},stop:function(){this.flags.renderingPaused=true;this.frameTimer.stop()},pause:function(){this.flags.renderingPaused=true},resume:function(){this.flags.renderingPaused=false;this.resetPerf()},onFrame:function(delta,timer){var now=this.now();var tmp;if(delta>this.maxFrameInterval)delta=this.maxFrameInterval;if(this.fixedFrameInterval!=0)delta=this.fixedFrameInterval;if(!this.flags.renderingEnabled||this.flags.renderingPaused){this.frameDrawInProgress=true;try{this.draw(this.displayBuffer,this.context)}catch(e){console.error("DRAW ERROR: \n"+e+"\n"+e.stack)}this.frameDrawInProgress=false;return}if(this.perf.numFrames==0){this.perf.startTime=now-this.frameInterval;this.perf.lastTime=now}delta*=this.timeScale;this.frameDeltaMillis=delta;this.frameDelta=delta/1e3;this.frameTime+=this.frameDelta;this.frameNumber++;this.frameUpdateInProgress=true;tmp=hrnow();try{this.update(delta,this.context)}catch(e){console.error("UPDATE ERROR: "+e+"\n"+e.stack);System.stop()}this.perf.updateTime+=hrnow()-tmp;this.frameUpdateInProgress=false;this.frameDrawInProgress=true;tmp=hrnow();try{this.draw(this.displayBuffer,this.context)}catch(e){console.error("DRAW ERROR: \n"+e+"\n"+e.stack);System.stop()}this.perf.drawTime+=hrnow()-tmp;this.frameDrawInProgress=false;this.perf.lastTime=now;this.perf.numFrames++},onWindowResized:function(notRendering){if("document"in global){if(this.options.fullscreen){this._screenWidth=int(global.screen.width);this._screenHeight=int(global.screen.height)}else{this._screenWidth=global.innerWidth;this._screenHeight=global.innerHeight}}else{this._screenWidth=this.options.targetScreenWidth;this._screenHeight=this.options.targetScreenHeight}this.canvasScaleFactor=1;if(this._screenWidth<this._screenHeight&&this.orientation==System.LANDSCAPE||this._screenWidth>this._screenHeight&&this.orientation==System.PORTRAIT){this.screenWidth=this._screenHeight;this.screenHeight=this._screenWidth;this.reverseRender=true}else{this.screenWidth=this._screenWidth;this.screenHeight=this._screenHeight;this.reverseRender=false}let targetScreenWidth=this.options.targetScreenWidth;let targetScreenHeight=this.options.targetScreenHeight;if(this.orientation==System.AUTOMATIC&&targetScreenWidth&&targetScreenHeight){if(targetScreenWidth>targetScreenHeight&&this.screenWidth<this.screenHeight||targetScreenWidth<targetScreenHeight&&this.screenWidth>this.screenHeight){targetScreenWidth=targetScreenHeight;targetScreenHeight=this.options.targetScreenWidth}}if(targetScreenWidth&&targetScreenHeight){this.canvasScaleFactor=Math.min(this.screenWidth/targetScreenWidth,this.screenHeight/targetScreenHeight)}else if(targetScreenWidth){this.canvasScaleFactor=this.screenWidth/targetScreenWidth}else if(targetScreenHeight){this.canvasScaleFactor=this.screenHeight/targetScreenHeight}var _screenWidth=this.screenWidth;var _screenHeight=this.screenHeight;if(targetScreenWidth)this.screenWidth=targetScreenWidth;if(targetScreenHeight)this.screenHeight=targetScreenHeight;this.offsX=int((_screenWidth-this.screenWidth*this.canvasScaleFactor)*.5);this.offsY=int((_screenHeight-this.screenHeight*this.canvasScaleFactor)*.5);if(this.reverseRender){var tmp=this.offsX;this.offsX=this.offsY;this.offsY=tmp}this.scaleFactor=this.canvasScaleFactor*this.canvasPixelRatio;this.scaleFactor=~~(.7+this.scaleFactor);this.flags.renderingEnabled=false;if("document"in global)global.document.body.style.backgroundColor=this.displayBuffer.backgroundColor;if(!this.reverseRender){this.displayBuffer.resize(this.screenWidth*this.scaleFactor,this.screenHeight*this.scaleFactor);this.displayBuffer.elem.style.width=this.screenWidth*this.canvasScaleFactor+"px";this.displayBuffer.elem.style.height=this.screenHeight*this.canvasScaleFactor+"px"}else{this.displayBuffer.resize(this.screenHeight*this.scaleFactor,this.screenWidth*this.scaleFactor);this.displayBuffer.elem.style.width=this.screenHeight*this.canvasScaleFactor+"px";this.displayBuffer.elem.style.height=this.screenWidth*this.canvasScaleFactor+"px"}this.displayBuffer.elem.style.marginLeft=this.offsX+"px";this.displayBuffer.elem.style.marginTop=this.offsY+"px";this.displayBuffer.loadIdentity();if(this.scaleFactor!=1)this.displayBuffer.globalScale(this.scaleFactor);if(this.reverseRender){this.displayBuffer.rotate(-Math.PI/2);this.displayBuffer.translate(0,-this.screenHeight);this.displayBuffer.flipped(true)}this.scaleFactor*=this.options.extraScaleFactor;this.integerScaleFactor=~~(this.scaleFactor+.9);this.resetPerf();this.initialMatrix=this.displayBuffer.getMatrix();if(notRendering!=true){this.flags.renderingEnabled=true;this.onCanvasResized(this.screenWidth,this.screenHeight)}},onCanvasResized:function(screenWidth,screenHeight){},resetPerf:function(){this.perf.numFrames=0},updateQueueAdd:function(elem){this.updateQueue.push(elem);return this.updateQueue.bottom},updateQueueRemove:function(elem){this.updateQueue.remove(elem instanceof Linkable?elem:this.updateQueue.sgetNode(elem))},drawQueueAdd:function(elem){this.drawQueue.push(elem);return this.drawQueue.bottom},drawQueueRemove:function(elem){this.drawQueue.remove(elem instanceof Linkable?elem:this.drawQueue.sgetNode(elem))},queueAdd:function(elem){this.updateQueue.push(elem);this.drawQueue.push(elem);return elem},queueRemove:function(elem){this.updateQueue.remove(this.updateQueue.sgetNode(elem));this.drawQueue.remove(this.drawQueue.sgetNode(elem))},update:function(dt,context){this.dt=dt;var next;for(var elem=this.updateQueue.top;elem;elem=next){next=elem.next;elem.value.update(dt,context)}},draw:function(canvas,context){var next;for(var elem=this.drawQueue.top;elem;elem=next){next=elem.next;elem.value.draw(canvas,context)}},interpolate:function(src,dst,duration,easing,callback){let time={};let data={};let count=0;for(let x in src){time[x]=0;data[x]=src[x];count++}let interpolator={update:function(dt){dt/=1e3;for(let x in time){if(time[x]==duration[x])continue;time[x]+=dt;if(time[x]>=duration[x]){time[x]=duration[x];count--}data[x]=src[x]+(dst[x]-src[x])*easing[x](time[x]/duration[x])}callback(data,count==0);if(count==0)System.updateQueueRemove(interpolator)}};System.updateQueueAdd(interpolator);interpolator.update(0)},onKeyboardEvent:function(action,keyCode,keys){},onPointerEvent:function(action,pointer,pointers){}}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./canvas":3,"./globals":11,"./keycodes":28,"./linkable":29,"./list":30,"./timer":45}],45:[function(require,module,exports){require("./globals");const Timer=module.exports=function(interval,callback,context){this.callback=callback;this.context=context;this.interval=interval;this.highPerformance=true};Timer.prototype.onTimeout=function(){if(!this.isRunning)return;if(this.highPerformance){var targetTime=this.lastTime+this.interval;while(hrnow()<targetTime){}var curTime=hrnow();var delta=curTime-this.lastTime;this.lastTime=curTime;this.callback.call(this.context,delta,this);this.runAfter(0)}else{this.rTime=hrnow()-this.startTime;var tError=this.rTime-(this.sTime+this.interval);if(tError<0){this.runAfter(-tError);return}this.sTime+=this.interval*(1+int(tError/this.interval));this.tDelta=tError<0?this.interval:this.rTime-this.lTime;this.lTime=this.rTime;this.callback.call(this.context,this.tDelta,this);this.runAfter(this.sTime+this.interval-(hrnow()-this.startTime))}};Timer.prototype.onStart=function(){};Timer.prototype.start=function(){this.startTime=hrnow();this.sTime=0;this.lTime=0;this.lastTime=hrnow();this.isRunning=true;this.onStart();this.runAfter(this.interval)};Timer.prototype.runAfter=function(timeout){setTimeout(()=>this.onTimeout(),timeout)};Timer.prototype.stop=function(){this.isRunning=false}},{"./globals":11}],46:[function(require,module,exports){const Vec2=module.exports=function(){switch(arguments.length){case 0:return this.Vec2_0.apply(this,arguments);case 1:return this.Vec2_1.apply(this,arguments);case 2:return this.Vec2_2.apply(this,arguments)}};Vec2.prototype.x=0;Vec2.prototype.y=0;Vec2.prototype.Vec2_0=function(){this.x=this.y=0};Vec2.prototype.Vec2_2=function(x,y){this.x=x;this.y=y};Vec2.prototype.Vec2_1=function(b){this.x=b.x;this.y=b.y};Vec2.prototype.clone=function(){return new Vec2(this.x,this.y)};Vec2.prototype.set=function(x,y){if(arguments.length==1)this.x=x.x,this.y=x.y;else this.x=x,this.y=y;return this};Vec2.prototype.zero=function(){return this.set(0,0)};Vec2.prototype.isZero=function(){return this.x==0&&this.y==0};Vec2.prototype.equals=function(x,y){if(arguments.length==1)return this.x==x.x&&this.y==x.y;else return this.x==x&&this.y==y};Vec2.prototype.neg=function(){this.x=-this.x;this.y=-this.y;return this};Vec2.prototype.abs=function(){this.x=this.x<0?-this.x:this.x;this.y=this.y<0?-this.y:this.y;return this};Vec2.prototype.translate=function(dx,dy){if(arguments.length==1)this.x+=dx.x,this.y+=dx.y;else this.x+=dx,this.y+=dy;return this};Vec2.prototype.add=function(dx,dy){if(arguments.length==1)this.x+=dx.x,this.y+=dx.y;else this.x+=dx,this.y+=dy;return this};Vec2.prototype.sub=function(dx,dy){if(arguments.length==1)this.x-=dx.x,this.y-=dx.y;else this.x-=dx,this.y-=dy;return this};Vec2.prototype.scale=function(fx,fy){if(arguments.length==1)this.x*=fx,this.y*=fx;else this.x*=fx,this.y*=fy;return this};Vec2.prototype.floor=function(){this.x=~~this.x;this.y=~~this.y;return this};Vec2.prototype.fract=function(){this.x=this.x-~~this.x;this.y=this.y-~~this.y;return this};Vec2.prototype.dot=function(x,y){if(arguments.length==2)return this.x*x+this.y*y;else return this.x*x.x+this.y*x.y};Vec2.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};Vec2.prototype.normalize=function(){return this.isZero()?this:this.scale(1/this.magnitude())};Vec2.prototype.majorAxis=function(){if(Math.abs(this.x)>Math.abs(this.y))this.y=0;else this.x=0;return this};Vec2.prototype.minorAxis=function(){if(Math.abs(this.x)<Math.abs(this.y))this.y=0;else this.x=0;return this};Vec2.prototype.sign=function(){this.x=!this.x?0:this.x<0?-1:1;this.y=!this.y?0:this.y<0?-1:1;return this};Vec2.prototype.toString=function(){return`(${this.x}, ${this.y})`}},{}],47:[function(require,module,exports){const Rect=require("./rect");const Viewport=module.exports=function(sx,sy,width,height,worldWidth,worldHeight,focusFactorX,focusFactorY){this.focusFactorX=focusFactorX==undefined?.4:focusFactorX;this.focusFactorY=focusFactorY==undefined?.4:focusFactorY;this.focusTarget=null;this.sx=sx;this.sy=sy;if(width>worldWidth)width=worldWidth;if(height>worldHeight)height=worldHeight;this.width=width>>1;this.height=height>>1;worldWidth>>=1;worldHeight>>=1;this.worldX1=-worldWidth;this.worldY1=-worldHeight;this.worldX2=+worldWidth;this.worldY2=+worldHeight;this.bounds=Rect.alloc();this.focusBounds=Rect.alloc();this.screenBounds=Rect.alloc();this.x=0;this.y=0;this.enabled=true;this.updateScreenBounds();this.updateBounds()};Viewport.prototype.width=0;Viewport.prototype.height=0;Viewport.prototype.sx=0;Viewport.prototype.sy=0;Viewport.prototype.x=0;Viewport.prototype.y=0;Viewport.prototype.centerRatioX=0;Viewport.prototype.centerRatioY=0;Viewport.prototype.dx=0;Viewport.prototype.dy=0;Viewport.prototype.worldX1=0;Viewport.prototype.worldY1=0;Viewport.prototype.worldX2=0;Viewport.prototype.worldY2=0;Viewport.prototype.focusFactorX=0;Viewport.prototype.focusFactorY=0;Viewport.prototype.focusTarget=null;Viewport.prototype.enabled=false;Viewport.prototype.scale=1;Viewport.prototype.isEnabled=function(){return this.enabled};Viewport.prototype.setEnabled=function(enabled){this.enabled=enabled;return this};Viewport.prototype.updateBounds=function(){this.bounds.set(this.x-this.width/this.scale+this.dx,this.y-this.height/this.scale+this.dy,this.x+this.width/this.scale+this.dx,this.y+this.height/this.scale+this.dy);this.focusBounds.set(this.x-(this.focusFactorX*this.width+this.centerRatioX*this.width)/this.scale,this.y-(this.focusFactorY*this.height+this.centerRatioY*this.height)/this.scale,this.x+(this.focusFactorX*this.width+this.centerRatioX*this.width)/this.scale,this.y+(this.focusFactorY*this.height+this.centerRatioY*this.height)/this.scale)};Viewport.prototype.updateScreenBounds=function(){this.screenBounds.set(this.sx,this.sy,this.sx+(this.width<<1),this.sy+(this.height<<1))};Viewport.prototype.setSize=function(width,height){this.width=width>>1;this.height=height>>1;this.updateScreenBounds();this.updateBounds();return this};Viewport.prototype.setPosition=function(x,y,absolute=false){if(absolute===true){this.x=x;this.y=y;this.dx=this.dy=0}else{this.dx=x;this.dy=y}this.updateBounds();return this};Viewport.prototype.setScale=function(value){this.scale=value;this.updateScreenBounds();this.updateBounds();return this};Viewport.prototype.setCenter=function(rx,ry){this.centerRatioX=rx;this.centerRatioY=ry;return this};Viewport.prototype.translate=function(dx,dy){this.dx+=dx;this.dy+=dy;this.updateBounds();return this};Viewport.prototype.setScreenPosition=function(sx,sy){this.sx=sx;this.sy=sy;this.updateScreenBounds()};Viewport.prototype.getX=function(){return this.x+this.dx};Viewport.prototype.getY=function(){return this.y+this.dy};Viewport.prototype.getPositionX=function(){return this.dx};Viewport.prototype.getPositionY=function(){return this.dy};Viewport.prototype.getWidth=function(){return this.width<<1};Viewport.prototype.getHeight=function(){return this.height<<1};Viewport.prototype.getBounds=function(){return this.bounds};Viewport.prototype.getScreenBounds=function(){return this.screenBounds};Viewport.prototype.getFocusBounds=function(){return this.focusBounds};Viewport.prototype.focusOn=function(i,j,kx,ky){if(kx===undefined)kx=this.focusFactorX;if(ky===undefined)ky=this.focusFactorY;let x1=this.x-(kx*this.width+this.centerRatioX*this.width)/this.scale;let x2=this.x+(kx*this.width+this.centerRatioX*this.width)/this.scale;let y1=this.y-(ky*this.height+this.centerRatioY*this.height)/this.scale;let y2=this.y+(ky*this.height+this.centerRatioY*this.height)/this.scale;let nx=this.x;let ny=this.y;if(i<x1)nx+=i-x1;else if(i>x2)nx+=i-x2;if(j<y1)ny+=j-y1;else if(j>y2)ny+=j-y2;x1=nx-this.width;x2=nx+this.width;y1=ny-this.height;y2=ny+this.height;if(x1<this.worldX1)nx=this.worldX1+this.width;if(x2>this.worldX2)nx=this.worldX2-this.width;if(y1<this.worldY1)ny=this.worldY1+this.height;if(y2>this.worldY2)ny=this.worldY2-this.height;this.x=nx;this.y=ny;this.updateBounds()};Viewport.prototype.update=function(dt){if(this.focusTarget!=null)this.focusOn(this.focusTarget.getX(),this.focusTarget.getY())};Viewport.prototype.setFocusTarget=function(elem){this.focusTarget=elem;return this};Viewport.prototype.setFocusFactor=function(valueX,valueY){this.focusFactorX=valueX;this.focusFactorY=valueY===undefined?valueX:valueY;return this};Viewport.prototype.applyTransform=function(g){g.translate(~~this.screenBounds.cx,~~this.screenBounds.cy);g.scale(this.scale,this.scale);g.translate(-~~this.getX(),-~~this.getY())};Viewport.prototype.toWorldSpace=function(x,y){x=(x-~~this.screenBounds.cx)/this.scale+~~this.getX();y=(y-~~this.screenBounds.cy)/this.scale+~~this.getY();return{x:x,y:y}};Viewport.prototype.toScreenSpace=function(x,y){x=(x-~~this.getX())*this.scale+~~this.screenBounds.cx;y=(y-~~this.getY())*this.scale+~~this.screenBounds.cy;return{x:x,y:y}}},{"./rect":41}],48:[function(require,module,exports){require("./globals");const Class=require("@rsthn/rin/class");const Rect=require("./rect");const List=require("./list");const QuadTree=require("./quadtree");const Viewport=require("./viewport");const System=require("./system");const DisplayElement=require("./display-element");const World=module.exports=Class.extend({rect:null,bounds:null,numViewports:0,viewports:null,worldWidth:0,worldHeight:0,numLayers:0,layers:null,onLayerDrawn:null,updateQueue:null,drawQueue:null,fullClear:true,drawHollow:false,__ctor:function(numViewports,numLayers,worldWidth,worldHeight,focusFactor){if(focusFactor===undefined)focusFactor=.2;this.numLayers=numLayers;this.numViewports=numViewports;this.worldWidth=worldWidth;this.worldHeight=worldHeight;var halfX=worldWidth+0>>1;var halfY=worldHeight+0>>1;var minX=-halfX;var maxX=halfX;var minY=-halfY;var maxY=halfY;this.layers=new Array;this.viewports=new Array;this.updateQueue=new List;this.drawQueue=new List;this.onLayerDrawn=[];for(var i=0;i<numLayers;i++)this.layers[i]=new QuadTree(minX,minY,maxX,maxY,16);for(var i=0;i<numViewports;i++)this.viewports[i]=new Viewport(0,0,System.screenWidth,System.screenHeight,worldWidth,worldHeight,focusFactor);this.bounds=Rect.alloc(worldWidth,worldHeight);this.rect=Rect.alloc()},__dtor:function(){for(var i=0;i<this.numLayers;i++)dispose(this.layers[i]);for(var i=0;i<this.numViewports;i++)dispose(this.viewports[i]);dispose(this.updateQueue);dispose(this.drawQueue)},getWidth:function(){return this.worldWidth},getHeight:function(){return this.worldHeight},getViewport:function(index){if(index<0||index>=this.numViewports)return null;return this.viewports[index]},getBounds:function(){return this.bounds},getLayer:function(layer){if(layer<0||layer>=this.numLayers)return null;return this.layers[layer]},updateQueueAdd:function(elem){this.updateQueue.push(elem)},updateQueueRemove:function(elem){this.updateQueue.remove(this.updateQueue.sgetNode(elem))},drawQueueAdd:function(elem){this.drawQueue.push(elem)},drawQueueRemove:function(elem){this.drawQueue.remove(this.drawQueue.sgetNode(elem))},queueAdd:function(elem){this.drawQueue.push(elem);this.updateQueue.push(elem)},queueRemove:function(elem){this.drawQueue.remove(this.drawQueue.sgetNode(elem));this.updateQueue.remove(this.updateQueue.sgetNode(elem))},draw:function(g){if(this.fullClear)g.clear(true);for(var viewportIndex=0;viewportIndex<this.numViewports;viewportIndex++){var viewport=this.viewports[viewportIndex];if(!viewport.isEnabled())continue;g.save();let clipArea=viewport.getScreenBounds();g.beginPath();g.rect(clipArea.x1,clipArea.y1,clipArea.width(),clipArea.height());g.clip();g.pushMatrix();viewport.applyTransform(g);this.rect.set(viewport.getBounds());for(var layerIndex=0;layerIndex<this.numLayers;layerIndex++){var layer=this.layers[layerIndex];if(!layer.getVisible())continue;var elem;layer.selectItems(this.rect);layer.selectedCount=0;while((elem=layer.getNextSelectedItem())!=null){if(elem.getFlags(DisplayElement.FLAG_FRAGMENT))continue;if(elem.getFlags(DisplayElement.FLAG_HOLLOW)&&this.drawHollow!==true)continue;layer.selectedCount++;elem.draw(g)}if(this.onLayerDrawn[layerIndex])this.onLayerDrawn[layerIndex](g)}g.popMatrix();g.restore()}for(var elem=this.drawQueue.top;elem;elem=elem.next)elem.value.draw(g)},update:function(dt){var dtm=dt;dt/=1e3;this.updateElems(dt,dtm);this.onUpdated(dt,dtm);this.updateLayers();this.updateViewports(dt,dtm)},onUpdated:function(dt,dtm){},updateElems:function(dt,dtm){var elem_next;for(var elem=this.updateQueue.top;elem;elem=elem.next)elem._used=false;for(var elem=this.updateQueue.top;elem;elem=elem_next){elem_next=elem.next;if(elem._used)continue;var eId=elem.objectId;elem._used=true;elem.value.update(dt,dtm);if(elem.objectId!=eId){elem=this.updateQueue.top;continue}}},updateViewports:function(dt,dtm){for(var viewportIndex=0;viewportIndex<this.numViewports;viewportIndex++){var viewport=this.viewports[viewportIndex];if(!viewport.isEnabled())continue;viewport.update(dt,dtm)}},updateLayers:function(){for(var layer=0;layer<this.numLayers;layer++)this.layers[layer].update()},truncatePosition:function(elem){var elemBounds=elem.getBounds();var value=0;if(elemBounds.x2>this.bounds.x2)elem.translate(this.bounds.x2-elemBounds.x2,0),value|=1<<3;if(elemBounds.y2>this.bounds.y2)elem.translate(0,this.bounds.y2-elemBounds.y2),value|=1<<1;if(elemBounds.x1<this.bounds.x1)elem.translate(this.bounds.x1-elemBounds.x1,0),value|=1<<2;if(elemBounds.y1<this.bounds.y1)elem.translate(0,this.bounds.y1-elemBounds.y1),value|=1<<0;return value},moveToContact:function(a,b){var ra=a.getLBounds();var rb=b.getLBounds();var p_ra=a.getLastBounds();var tmp=a.getBounds();p_ra=this.rect.set(ra).translate(p_ra.x1-tmp.x1,p_ra.y1-tmp.y1);var delta=new Vec2;delta.set(a.getVelocity());var t_bottom=ra.y2==p_ra.y2?-1:(rb.y1-p_ra.y2)/(ra.y2-p_ra.y2);var t_top=ra.y1==p_ra.y1?-1:(rb.y2-p_ra.y1)/(ra.y1-p_ra.y1);var t_left=ra.x1==p_ra.x1?-1:(rb.x2-p_ra.x1)/(ra.x1-p_ra.x1);var t_right=ra.x2==p_ra.x2?-1:(rb.x1-p_ra.x2)/(ra.x2-p_ra.x2);var dir=0;if(t_top<0||t_top>1)t_top=1048576;if(t_bottom<0||t_bottom>1)t_bottom=1048576;if(t_left<0||t_left>1)t_left=1048576;if(t_right<0||t_right>1)t_right=1048576;if(t_top!=1048576&&t_top<t_bottom&&t_top<t_left&&t_top<t_right){dir="D_TOP"}else if(t_bottom!=1048576&&t_bottom<t_left&&t_bottom<t_right){dir="D_BOTTOM"}else if(t_left!=1048576&&t_left<t_right){dir="D_LEFT"}else if(t_right!=1048576){dir="D_RIGHT"}switch(dir){case"D_TOP":a.translate(0,rb.y2-ra.y1);a.getVelocity().y=0;break;case"D_BOTTOM":a.translate(0,rb.y1-ra.y2);a.getVelocity().y=0;break;case"D_LEFT":a.translate(rb.x2-ra.x1,0);a.getVelocity().x=0;break;case"D_RIGHT":a.translate(rb.x1-ra.x2,0);a.getVelocity().x=0;break}}});World.T_TOP=1;World.T_BOTTOM=2;World.T_LEFT=4;World.T_RIGHT=8},{"./display-element":8,"./globals":11,"./list":30,"./quadtree":40,"./rect":41,"./system":44,"./viewport":47,"@rsthn/rin/class":35}],49:[function(require,module,exports){module.exports={Drawable:require("./wrappers/drawable"),DrawableRect:require("./wrappers/drawable-rect"),SpriteSheet:require("./wrappers/spritesheet"),SpriteSheetAnimation:require("./wrappers/spritesheet-animation"),SpriteFont:require("./wrappers/spritefont"),Sound:require("./wrappers/sound"),SoundArray:require("./wrappers/sound-array")}},{"./wrappers/drawable":51,"./wrappers/drawable-rect":50,"./wrappers/sound":53,"./wrappers/sound-array":52,"./wrappers/spritefont":54,"./wrappers/spritesheet":56,"./wrappers/spritesheet-animation":55}],50:[function(require,module,exports){const Class=require("@rsthn/rin/class");module.exports=Class.extend({className:"DrawableRect",width:null,height:null,__ctor:function(r){if(r.type!="object")throw new Error("Resource is not an object.");this.r=r;this.r.wrapper=this;this.width=this.r.width;this.height=this.r.height},draw:function(g,x,y){g.fillStyle(this.r.color);g.fillRect(x,y,this.width,this.height)},getDrawable:function(){return this}})},{"@rsthn/rin/class":35}],51:[function(require,module,exports){const Class=require("@rsthn/rin/class");module.exports=Class.extend({className:"Drawable",width:null,height:null,__ctor:function(r){if(r.type!="image")throw new Error("Resource is not an image.");this.r=r;this.r.wrapper=this;this.width=this.r.width;this.height=this.r.height},draw:function(g,x,y,width,height){if(width==null)g.drawImageResource(this.r,x,y);else g.drawImageResource(this.r,x,y,width,height)},getDrawable:function(){return this}})},{"@rsthn/rin/class":35}],52:[function(require,module,exports){require("../globals");const Rin=require("@rsthn/rin/alpha");const Class=require("@rsthn/rin/class");const Sound=require("./sound");module.exports=Class.extend({r:null,__ctor:function(r){if(r.type!="audios")throw new Error("Resource is not audios.");this.r=r;this.r.wrapper=this;if(!this.r.track)this.r.track="sfx";if(!this.r.mode)this.r.mode="random";this.track=Sound[this.r.track.toUpperCase()];this.sounds=[];this.lastIndex=-1;for(var i=0;i<this.r.data.length;i++){this.sounds.push(new Sound(Rin.override(this.r.data[i],{track:this.r.track})))}},getRandomSound:function(){if(this.r.mode=="random")return this.sounds[randr(0,this.sounds.length-1)];this.lastIndex=++this.lastIndex%this.sounds.length;return this.sounds[this.lastIndex]},play:function(callback,volume){return Sound.play(this.getRandomSound(),callback,volume)},playLoop:function(callback,volume){return Sound.playLoop(this.getRandomSound(),callback,volume)},playAt:function(index,callback,volume){return Sound.play(this.sounds[index%this.sounds.length],callback,volume)},playLoopAt:function(index,callback,volume){return Sound.playLoop(this.sounds[index%this.sounds.length],callback,volume)}})},{"../globals":11,"./sound":53,"@rsthn/rin/alpha":34,"@rsthn/rin/class":35}],53:[function(require,module,exports){(function(global){const Rin=require("@rsthn/rin/alpha");const Class=require("@rsthn/rin/class");const Sound=module.exports=Class.extend({r:null,__ctor:function(r){if(r.type!="audio")throw new Error("Resource is not audio.");this.r=r;this.r.wrapper=this;this.track=Sound[this.r.track.toUpperCase()]},play:function(callback,volume){return Sound.play(this,callback,volume)},playLoop:function(callback,volume){return Sound.playLoop(this,callback,volume)}});Sound.ENGINE_HTML5=1;Sound.ENGINE_WEBAUDIO=2;Sound.ENGINE_NATIVEAUDIO=3;Rin.override(Sound,{MASTER:{enabled:true,volume:1},SFX:{enabled:true,volume:1},MUSIC:{enabled:true,volume:.8},VOICE:{enabled:true,volume:1},MAX_POOL_SIZE:100,pool:[],active:[],register:function(node){if(node.registered)return;node.registered=true;this.active.push(node)},unregister:function(node){if(!node.registered)return;node.registered=false;var i=Sound.active.indexOf(node);if(i==-1)return;Sound.active.splice(i,1)},updateNode:function(node,cmd){switch(node.snd.r.engine){case Sound.ENGINE_WEBAUDIO:return this.updateNode_webaudio(node,cmd);case Sound.ENGINE_NATIVEAUDIO:return this.updateNode_nativeaudio(node,cmd)}return this.updateNode_audio(node,cmd)},alloc_webaudio:function(node){node.gainNode=audioContext.createGain();node.gainNode.gain.value=0;node.gainNode.connect(audioContext.destination);node.res=audioContext.createBufferSource();node.res.buffer=node.snd.r.data;node.res.loop=false;node.res.connect(node.gainNode);node.res.node=node},free_webaudio:function(node){if(!node.res)return;node.gainNode.disconnect();node.res=null;node.gainNode=null},alloc_nativeaudio:function(node){node.res=true},free_nativeaudio:function(node){node.res=false},alloc_audio:function(node){if(!this.pool.length)item=node.cloneNode();else item=this.pool.pop();item._src=node.src;return item},free_audio:function(node){if(this.pool.length==this.MAX_POOL_SIZE)return;this.pool.push(node)},updateNode_webaudio:function(node,cmd){if(!node)return null;var volume=Sound.MASTER.volume*node.snd.track.volume*node.volume;switch(cmd){case"play":if(node.playing)break;if(!node.res)Sound.alloc_webaudio(node);node.playTime=hrnow();node.playing=true;node.pause=false;node.res.onended=Sound.onended_webaudio;node.gainNode.gain.value=volume;try{node.res.start(0,node.startTime/1e3)}catch(e){Sound.free_webaudio(node);return null}Sound.register(node);break;case"setvolume":if(!node.res)break;node.gainNode.gain.value=volume;break;case"stop":if(!node.playing&&node.paused){node.startTime=0;node.paused=false;Sound.free_webaudio(node);if(node.callback)node.callback();break}if(!node.res)break;node.startTime=0;node.playing=false;node.pause=false;node.res.onended=null;Sound.unregister(node);node.res.stop();Sound.free_webaudio(node);if(node.callback)node.callback();break;case"pause":if(!node.playing||!node.res)break;node.startTime+=hrnow()-node.playTime;node.playing=false;node.pause=true;node.res.onended=null;Sound.unregister(node);node.res.stop();Sound.free_webaudio(node);break;case"softstop":if(!node.playing&&node.paused){node.startTime=0;node.paused=false;break}if(!node.playing||!node.res)break;node.startTime=0;node.playing=false;node.pause=false;node.res.loop=false;break}return node},onended_webaudio:function(e){var node=e.currentTarget.node;if(node.playing&&node.loop!=0){Sound.free_webaudio(node);if(node.loop!=-1)node.loop--;node.startTime=0;node.playing=false;node.pause=false;Sound.updateNode_webaudio(node,"play");return}node.res.onended=null;node.res.volume=0;Sound.updateNode_webaudio(node,"stop")},updateNode_nativeaudio:function(node,cmd){if(!node)return null;switch(cmd){case"play":if(node.playing)break;if(!node.res)Sound.alloc_nativeaudio(node);node.playing=true;node.pause=false;try{global.plugins.NativeAudio.play(node.snd.r.data,null,null,function(){Sound.onended_nativeaudio(node)})}catch(e){Sound.free_nativeaudio(node);return null}Sound.register(node);break;case"setvolume":break;case"stop":if(!node.res)break;node.playing=false;node.pause=false;Sound.unregister(node);global.plugins.NativeAudio.stop(node.snd.r.data,null);Sound.free_nativeaudio(node);if(node.callback)node.callback();break;case"pause":break;case"softstop":break}return node},onended_nativeaudio:function(node){Sound.updateNode_nativeaudio(node,"stop")},updateNode_audio:function(node,cmd){if(!node)return null;var volume=Sound.MASTER.volume*node.snd.track.volume*node.volume;switch(cmd){case"play":if(node.playing)break;if(!node.res){node.res=Sound.alloc_audio(node.snd.r.data);node.res.node=node;node.res.src=node.res._src}node.playTime=hrnow();node.playing=true;node.pause=false;node.res.onended=Sound.onended_audio;node.res.currentTime=node.startTime/1e3;node.res.volume=volume;try{node.res.play()}catch(e){Sound.free_audio(node.res);node.res=null;return null}Sound.register(node);break;case"setvolume":if(!node.res)break;node.res.volume=volume;break;case"stop":if(!node.playing&&node.paused){node.startTime=0;node.paused=false;Sound.free_audio(node.res);node.res=null;if(node.callback)node.callback();break}if(!node.res)break;node.startTime=0;node.playing=false;node.pause=false;Sound.unregister(node);node.res.pause();Sound.free_audio(node.res);node.res=null;if(node.callback)node.callback();break;case"pause":if(!node.playing||!node.res)break;node.startTime+=hrnow()-node.playTime;node.playing=false;node.pause=true;Sound.unregister(node);node.res.pause();break;case"softstop":if(!node.playing&&node.paused){node.startTime=0;node.paused=false;break}if(!node.playing||!node.res)break;node.startTime=0;node.playing=false;node.pause=false;break}return node},onended_audio:function(e){var node=e.currentTarget.node;if(node.playing&&node.loop!=0){if(node.loop!=-1)node.loop--;node.startTime=0;node.playing=false;node.pause=false;Sound.updateNode_audio(node,"play");return}node.res.onended=null;node.res.volume=0;Sound.updateNode_audio(node,"stop")},enableTrack:function(track){if(!track)return;track.enabled=true},disableTrack:function(track){if(!track)return;track.enabled=false},setVolume:function(track,value){if(!track)return;track.volume=value},createNode:function(snd,volume){var node={};node.startVolume=volume;node.volume=volume;node.snd=snd;node.loop=0;node.playing=false;node.paused=false;node.startTime=0;node.playTime=0;node.callback=null;node.timer=null;node.res=null;return node},play:function(snd,completeCallback,volume){if(!this.MASTER.enabled||!snd||!snd.track.enabled)return null;var volume=volume!==undefined&&volume!==null?volume:1;var node=this.createNode(snd,volume);node.callback=completeCallback;return this.updateNode(node,"play")},playLoop:function(snd,completeCallback,volume){if(!this.MASTER.enabled||!snd||!snd.track.enabled)return null;volume=volume!==undefined&&volume!==null?volume:1;var node=this.createNode(snd,volume);node.callback=completeCallback;node.loop=-1;return this.updateNode(node,"play")},stop:function(node,callback){if(!node)return null;if(callback&&callback!==true)node.callback=callback;return this.updateNode(node,callback===true?"stop":"softstop")},pause:function(node){if(!node)return null;return this.updateNode(node,"pause")},resume:function(node){if(!node)return null;return this.updateNode(node,"play")},fadeOut:function(node,millis,callback){if(!node)return;if(!node.playing||node.timer){if(callback)callback();return}var startTime=hrnow();node.startVolume=node.volume;node.timer=setInterval(function(){var t=(hrnow()-startTime)/millis;if(t>1)t=1;node.volume=node.startVolume*(1-t);Sound.updateNode(node,"setvolume");if(t==1){clearInterval(node.timer);node.timer=null;if(callback===true)Sound.updateNode(node,"stop");else Sound.updateNode(node,"pause");if(callback&&callback!==true)callback()}},50)},fadeIn:function(node,millis,callback){if(!node)return;if(node.playing||node.timer){if(callback)callback();return}var startTime=hrnow();node.volume=0;this.updateNode(node,"play");node.timer=setInterval(function(){var t=(hrnow()-startTime)/millis;if(t>1)t=1;node.volume=node.startVolume*t;Sound.updateNode(node,"setvolume");if(t==1){clearInterval(node.timer);node.timer=null;if(callback)callback()}},50)}})}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"@rsthn/rin/alpha":34,"@rsthn/rin/class":35}],54:[function(require,module,exports){const Class=require("@rsthn/rin/class");const Canvas=require("../canvas");module.exports=Class.extend({__ctor:function(r){if(r.type!="image"||!r.font)throw new Error("Resource is not a sprite font.");var r_scale=r.data.width/r.font.sheetWidth;var v_scale=r.width/r.font.sheetWidth;this.r_charWidth=r.font.charWidth*r_scale;this.r_charHeight=r.font.charHeight*r_scale;this.charWidth=r.font.charWidth*v_scale;this.charHeight=r.font.charHeight*v_scale;var cols=~~(r.font.sheetWidth/r.font.charWidth);this.r=r;this.r.wrapper=this;var n=r.font.charset.length;var k=0;var y=0;this.charTable={};this.charTable[" "]={charWidth:this.charWidth>>1,r_charWidth:this.r_charWidth};while(k<n){var x=0;for(var i=0;i<cols&&k<n;i++){var c=r.font.charset[k++];this.charTable[c]={x:x,y:y,charWidth:this.charWidth,r_charWidth:this.r_charWidth};x+=this.r_charWidth}y+=this.r_charHeight}if(!r.font.widths)return;var n=r.font.widths.length;for(var i=0;i<n;i+=2){var w1=r.font.widths[i]*v_scale;var w2=r.font.widths[i]*r_scale;var s=r.font.widths[i+1];for(var j=0;j<s.length;j++){this.charTable[s[j]].charWidth=w1;this.charTable[s[j]].r_charWidth=w2}}},draw:function(g,x,y,text){var n=text.length;for(var i=0;i<n;i++){if(text[i]==" "){x+=this.charTable[text[i]].charWidth;continue}var c=this.charTable[text[i]];if(!c)continue;g.drawImage(this.r.data,c.x,c.y,c.r_charWidth,this.r_charHeight,x,y,c.charWidth,this.charHeight);x+=c.charWidth}},measureWidth:function(text){var n=text.length;var x=0;for(var i=0;i<n;i++){var c=this.charTable[text[i]];if(!c)continue;x+=c.charWidth}return x},measureHeight:function(text){return this.charHeight}});Canvas.prototype.drawText=function(r,x,y,text){r.draw(this,x,y,text.toString())};Canvas.prototype.drawTextAligned=function(r,x,y,w,h,ax,ay,text){text=text.toString();if(ax==0)x=x+(w-r.measureWidth(text)>>1);else if(ax<0)x=x-ax-1;else if(ax>0)x=x+w-ax+1-r.measureWidth(text);if(ay==0)y=y+(h-r.measureHeight(text)>>1);else if(ay<0)y=y-ay-1;else if(ay>0)y=y+h-ay+1-r.measureHeight(text);r.draw(this,x,y,text)};Canvas.prototype.drawTextAligned2=function(r,bounds,ax,ay,text){this.drawTextAligned(r,bounds.x1,bounds.y1,bounds.width(),bounds.height(),ax,ay,text)}},{"../canvas":3,"@rsthn/rin/class":35}],55:[function(require,module,exports){const Class=require("@rsthn/rin/class");const SpriteSheet=require("./spritesheet");const System=require("../system");const Animation=Class.extend({seq:null,seq_i:0,trans:null,trans_i:0,trans_t:null,queue:null,fps:0,frameMillis:0,time:0,frameNumber:-1,finished:false,paused:false,width:null,height:null,onFinishedCallback:null,onFinishedArg:null,onFrameCallback:null,onFrameArg:null,__ctor:function(anim,seq,fps){this.anim=anim;this.queue=[];this.seq=seq;this.trans=null;this.width=anim.width;this.height=anim.height;this.fps=fps;this.setFps(this.seq.fps||this.fps)},__dtor:function(){},setFps:function(fps){this.frameMillis=~~(1e3/fps);this.time=0;return this},setPaused:function(value){this.paused=value;return this},setInitialDelay:function(dt){this.time=-dt*1e3;return this},onFinished:function(fn,arg){this.onFinishedCallback=fn;this.onFinishedArg=arg;return this},onFrame:function(fn,arg){this.onFrameCallback=fn;this.onFrameArg=arg;return this},setFrame:function(i){this.seq_i=i%this.seq.group.length;return this},getFrame:function(normalized){return normalized===true?this.seq_i/(this.seq.group.length-1):this.seq_i},getLength:function(){return this.seq.group.length},draw:function(g,x,y){if(this.time<0){if(!this.paused){this.time+=this.frameNumber==System.frameNumber?0:System.frameDeltaMillis;this.frameNumber=System.frameNumber}if(this.time>0)this.time=0;return}if(this.seq_i==this.seq.group.length){var t=this.seq.group[this.seq_i-1];if(g!=null){for(var i=0;i<t.length;i++)g.drawFrame(this.anim,x,y,t[i])}return}var t=this.seq.group[this.seq_i];if(g!=null){for(var i=0;i<t.length;i++)g.drawFrame(this.anim,x,y,t[i])}if(!this.paused){this.time+=this.frameNumber==System.frameNumber?0:System.frameDeltaMillis;this.frameNumber=System.frameNumber}if(this.time>=this.frameMillis){const frameIndex=this.seq_i;this.time-=this.frameMillis;this.seq_i++;if(this.seq_i==this.seq.group.length){if(this.trans!=null){if(++this.trans_i==this.trans.length){this.trans=null;this.seq=this.trans_t}else this.seq=this.trans[this.trans_i];this.seq_i=0;this.time=0;this.finished=false}else{if(this.seq.loop)this.seq_i=0;else{this.finished=true;if(this.onFinishedCallback){this.onFinishedCallback(this.onFinishedArg);this.onFinishedCallback=null}}if(this.queue.length)this.use(this.queue.shift(),true)}}if(this.onFrameCallback){if(this.onFrameCallback(frameIndex,this.seq.group.length-1,this.onFrameArg)===false)this.onFrameCallback=null}}},advance:function(){this.setPaused(false);this.draw(null,0,0)},use:function(seqName,force){var seq=this.trans==null?this.seq:this.trans_t;if(seq.name==seqName&&force!==true)return this;if(seq.trans&&seq.trans[seqName]){this.trans_t=this.anim.a.seq[seqName];this.trans=seq.trans[seqName];this.trans_i=0;this.seq=this.trans[this.trans_i]}else{this.seq=this.anim.a.seq[seqName];this.setFps(this.seq.fps||this.fps)}this.seq_i=0;this.time=0;this.finished=false;return this},setQueue:function(list){this.queue=list;this.use(this.queue.shift(),true)},enqueue:function(seqName,force){var seq=this.trans==null?this.seq:this.trans_t;if(seq.name==seqName&&seq.loop)return this;if(force!==true&&this.queue.length>0&&this.queue[this.queue.length-1]==seqName)return this;if(seq.loop||this.finished){this.use(seqName,true);return this}this.queue.push(seqName);return this}});const SpriteSheetAnimation=module.exports=SpriteSheet.extend({className:"SpriteSheetAnimation",__ctor:function(r){if(!r.anim)throw new Error("Animation descriptors not found.");this._super.SpriteSheet.__ctor(r);this.r=r;this.r.wrapper=this;var t=this.a=this.r.anim;if(t.initialized)return;if(!t.def)t.def="def";if(!t.seq)t.seq={};if(!t.seq[t.def]&&(t.def=="def"||t.def=="defloop")){var p={loop:t.def=="def"?false:true,group:[]};for(var i=0;i<this.numFrames;i++){p.group.push([i])}t.seq[t.def]=p}if(!t.seq[t.def])throw new Error("Undefined default sequence: "+t.def);if(!t.fps)t.fps=25;t.def=t.seq[t.def];var frameIndex=0;for(var i in t.seq){t.seq[i].name=i;if(!t.seq[i].loop)t.seq[i].loop=false;if(typeof t.seq[i].group=="string"){var a,b,c;if(t.seq[i].group.indexOf(" ")!=-1){a=t.seq[i].group.split(" ");t.seq[i].group=[];for(var j in a)t.seq[i].group.push([int(a[j])])}else if(t.seq[i].group.indexOf(",")!=-1){c=t.seq[i].group.split(",");a=int(c[0]);b=int(c[1]);t.seq[i].group=[];for(c=a;c<=b;c++)t.seq[i].group.push([c])}else{a=int(t.seq[i].group);t.seq[i].group=[];while(a--)t.seq[i].group.push([frameIndex++])}}}if(t.trans){for(var i in t.trans){t.seq[i].trans=t.trans[i];for(var j in t.trans[i]){for(var k=0;k<t.trans[i][j].length;k++){var n=t.trans[i][j][k];if(!t.seq[n])throw new Error("Undefined sequence: "+n);t.trans[i][j][k]=t.seq[n]}}}}t.initialized=true},getDrawable:function(initialseq,fps){return new Animation(this,initialseq?this.a.seq[initialseq]:this.a.def,fps||this.a.fps)},getSequence:function(initialseq){return initialseq?this.a.seq[initialseq]:this.a.def}})},{"../system":44,"./spritesheet":56,"@rsthn/rin/class":35}],56:[function(require,module,exports){const Class=require("@rsthn/rin/class");const Canvas=require("../canvas");module.exports=Class.extend({className:"SpriteSheet",width:0,height:0,numCols:0,numFrames:0,drawableCache:null,__ctor:function(r){if(r.type!="image"&&r.type!="images")throw new Error("Resource is not a sprite sheet.");var r_scale,v_scale;if(r.type=="image"){if(!r.config.sheetWidth&&(!r.config.numFrames||!r.config.frameWidth))throw new Error("Required sheetWidth or numFrames+frameWidth");if(!r.config.sheetWidth)r.config.sheetWidth=r.config.numFrames*r.config.frameWidth;if(!r.config.frameHeight)r.config.frameHeight=r.data.height;r_scale=r.data.width/r.config.sheetWidth;v_scale=r.width/r.config.sheetWidth}else{if(!r.config)r.config={};if(!r.config.frameWidth)r.config.frameWidth=r.data[0].width;if(!r.config.frameHeight)r.config.frameHeight=r.data[0].height;r_scale=r.data[0].data.width/r.config.frameWidth;v_scale=r.data[0].width/r.config.frameWidth}var _width=r.config.frameWidth;var _height=r.config.frameHeight;this.r_frameWidth=_width*r_scale;this.r_frameHeight=_height*r_scale;this.width=_width*v_scale;this.height=_height*v_scale;if(r.type=="image"){this.numCols=~~(r.data.width/this.r_frameWidth);this.numRows=Math.ceil(r.data.height/this.r_frameHeight);this.numFrames=r.config.numFrames||this.numCols*this.numRows}else{this.numCols=this.numRows=0;this.numFrames=r.data.length}this.drawableCache={};this.r=r;this.r.wrapper=this},drawFrame:function(g,x,y,frame){if(frame<0||frame>=this.numFrames)return;if(this.numCols!=0){var j=~~(frame/this.numCols)*this.r_frameHeight;var i=frame%this.numCols*this.r_frameWidth;g.drawImage(this.r.data,i,j,this.r_frameWidth,this.r_frameHeight,x,y,this.width,this.height)}else g.drawImage(this.r.data[frame].data,0,0,this.r_frameWidth,this.r_frameHeight,x,y,this.width,this.height)},getDrawable:function(frameIndex){if(arguments.length==2)frameIndex=arguments[1]*this.numCols+arguments[0];if(!this.drawableCache[frameIndex]){this.drawableCache[frameIndex]={width:this.width,height:this.height,frameIndex:frameIndex,r:this,draw:function(g,x,y){g.drawFrame(this.r,x,y,this.frameIndex)}}}return this.drawableCache[frameIndex]}});Canvas.prototype.drawFrame=function(r,x,y,frameIndex){r.drawFrame(this,x,y,frameIndex)}},{"../canvas":3,"@rsthn/rin/class":35}]},{},[32]);
